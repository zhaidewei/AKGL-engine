# AWS EventBridge Scheduling

**Learning Point**: 8.2 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 8.1 (AWS Lambda)、理解 cron 表达式
**Version**: AWS EventBridge

---

## Definition (Engineering Language)

**AWS EventBridge Scheduling**: 使用 AWS EventBridge 通过 cron 表达式或 rate 表达式按计划触发 Lambda 函数。

**EventBridge Rule**: 定义何时以及如何触发目标（Lambda 函数）。使用 cron 表达式进行基于时间的调度。

**Cron Expression**: 定义计划的字符串格式（例如，`*/15 * * * ? *` = 每 15 分钟）。

**EventBridge Target**: 要触发的资源（在 MarketLag 情况下是 Lambda 函数）。

**Target Configuration**: 如何调用目标的设置（输入转换、重试策略等）。

---

## Plain Language Explanation

将 EventBridge 想象成一个闹钟：

- **EventBridge Rule** = 闹钟："每 15 分钟叫醒我"
- **Cron Expression** = 计划："*/15 * * * ? *" = 每 15 分钟
- **Target** = 要做什么："触发 Lambda 函数"

**Why Needed**: MarketLag 使用 EventBridge 每 15 分钟触发 RSS producer，每小时触发 Polymarket producer。

---

## Analogy

如果您了解 **cron jobs**（您了解），EventBridge 是类似的：
- Cron schedule = EventBridge cron expression（两者都定义计划）
- Cron command = EventBridge target（两者都执行某些操作）
- Cron daemon = EventBridge service（两者都按计划触发）

关键区别：EventBridge 是无服务器的，无需管理服务器。

---

## Relationship to Already Learned Topics

- **8.1 AWS Lambda**: EventBridge 触发 Lambda 函数
- **7.1 RSS Processing**: RSS producer 每 15 分钟触发一次
- **7.2 Polymarket API**: Polymarket producer 每小时触发一次
- **Cron**: 您已经了解 cron - EventBridge 使用类似的语法

---

## EventBridge Rule Creation: Cron Expressions

### Cron Expression Format

**Format**: `minute hour day-of-month month day-of-week year`

**Example**: `*/15 * * * ? *`
- `*/15` = 每 15 分钟
- `*` = 每小时
- `*` = 每月的每一天
- `*` = 每月
- `?` = 不指定星期几
- `*` = 每年

### MarketLag Cron Expressions

**RSS Producer**: `*/15 * * * ? *`（每 15 分钟）
- 触发时间：每小时 :00、:15、:30、:45

**Polymarket Producer**: `0 * * * ? *`（每小时的第 0 分钟）
- 触发时间：每小时 :00（1:00、2:00、3:00 等）

---

## RSS Producer Cron: `*/15 * * * ? *` (Every 15 Minutes)

### Schedule

**Expression**: `*/15 * * * ? *`

**Triggers**: 每 15 分钟
- 00:00, 00:15, 00:30, 00:45
- 01:00, 01:15, 01:30, 01:45
- 等等

**Why 15 Minutes**:
- 在新鲜度和速率限制之间取得平衡
- RSS feeds 不会每分钟更新
- 避免达到 RSS.app 速率限制

**MarketLag**: RSS producer 使用此计划。

### EventBridge Rule Configuration

```json
{
  "Name": "rss-producer-schedule",
  "ScheduleExpression": "cron(*/15 * * * ? *)",
  "State": "ENABLED",
  "Targets": [
    {
      "Id": "1",
      "Arn": "arn:aws:lambda:region:account:function:rss-producer",
      "Input": "{}"
    }
  ]
}
```

---

## Polymarket Producer Cron: `0 * * * ? *` (Every Hour at Minute 0)

### Schedule

**Expression**: `0 * * * ? *`

**Triggers**: 每小时的第 0 分钟
- 00:00, 01:00, 02:00, 03:00, 等等

**Why Hourly**:
- 价格不会每分钟变化
- 每小时对于 lag 检测已经足够
- 减少 API 调用和成本

**MarketLag**: Polymarket producer 使用此计划。

### EventBridge Rule Configuration

```json
{
  "Name": "polymarket-producer-schedule",
  "ScheduleExpression": "cron(0 * * * ? *)",
  "State": "ENABLED",
  "Targets": [
    {
      "Id": "1",
      "Arn": "arn:aws:lambda:region:account:function:polymarket-producer",
      "Input": "{}"
    }
  ]
}
```

---

## EventBridge Target Configuration: Lambda Function

### Basic Configuration

**Target Type**: Lambda function

**Target ARN**: Lambda 函数 ARN

**Input**: 传递给 Lambda 的事件数据（可以是静态 JSON 或转换后的）

### MarketLag Configuration

```python
# EventBridge rule targets Lambda function
# Input: Empty JSON {} (Lambda doesn't need event data)
# Lambda handler receives event from EventBridge
```

### Lambda Handler Receiving Event

```python
def lambda_handler(event, context):
    """
    Lambda handler triggered by EventBridge.

    Args:
        event: EventBridge event (contains schedule info)
        context: Lambda context
    """
    # Event structure from EventBridge
    # {
    #   "version": "0",
    #   "id": "...",
    #   "detail-type": "Scheduled Event",
    #   "source": "aws.events",
    #   "time": "2024-01-15T14:00:00Z",
    #   "region": "us-east-1",
    #   "resources": ["arn:aws:events:..."],
    #   "detail": {}
    # }

    # Your producer logic
    fetch_and_send_data()

    return {'statusCode': 200}
```

---

## Minimum Viable Code

### EventBridge Rule (AWS Console or CLI)

```bash
# Create EventBridge rule for RSS producer
aws events put-rule \
    --name rss-producer-schedule \
    --schedule-expression "cron(*/15 * * * ? *)" \
    --state ENABLED

# Add Lambda target
aws events put-targets \
    --rule rss-producer-schedule \
    --targets "Id=1,Arn=arn:aws:lambda:region:account:function:rss-producer"
```

### Lambda Function

```python
import json

def lambda_handler(event, context):
    """
    Lambda handler triggered by EventBridge.
    """
    # EventBridge event contains schedule information
    event_time = event.get('time')  # Schedule time

    # Your producer logic
    try:
        # Fetch data (RSS or Polymarket)
        data = fetch_data()

        # Send to Kafka
        send_to_kafka(data)

        return {
            'statusCode': 200,
            'body': json.dumps({'message': 'Success', 'count': len(data)})
        }
    except Exception as e:
        print(f"Error: {e}")
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }
```

---

## Common Mistakes

1. **Wrong cron expression**:
   - ❌ `*/15 * * * *`（缺少年份字段，语法错误）
   - ✅ 使用 EventBridge 格式：`*/15 * * * ? *`

2. **Not enabling rule**:
   - ❌ 创建了规则但未启用
   - ✅ 将状态设置为 ENABLED

3. **Not adding target**:
   - ❌ 创建了规则但没有 Lambda target
   - ✅ 将 Lambda 函数添加为 target

4. **Wrong timezone**:
   - ❌ Cron 使用 UTC，期望本地时间
   - ✅ EventBridge cron 使用 UTC（如果需要则转换）

5. **Too frequent scheduling**:
   - ❌ 每分钟（达到速率限制，不必要）
   - ✅ 使用适当的间隔（RSS 15 分钟，价格 1 小时）

---

## Mind Trigger: When to Think About This

在以下情况下考虑 EventBridge 调度：
- **调度 producers**: MarketLag 调度 RSS（15 分钟）和 Polymarket（每小时）
- **创建规则**: 为定时任务设置 EventBridge 规则
- **配置目标**: 将 Lambda 函数添加为目标
- **理解 cron**: EventBridge 使用 cron 表达式
- **时区**: EventBridge 使用 UTC，如果需要则转换

**在 MarketLag 项目中**: 使用 EventBridge 每 15 分钟触发 RSS producer，每小时触发 Polymarket producer。理解 EventBridge 调度对于自动化数据获取至关重要。

---

## Summary

AWS EventBridge 调度使用 cron 表达式按计划触发 Lambda 函数。MarketLag 对 RSS producer 使用 `*/15 * * * ? *`（每 15 分钟），对 Polymarket producer 使用 `0 * * * ? *`（每小时）。EventBridge 规则以 Lambda 函数为目标。理解 EventBridge 调度对于自动化数据获取至关重要。
