# Source Weighting and Signal Calculation

**Learning Point**: 12.4 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 12.3 (Keyword Scoring), 3.1 (Window Functions), understanding of weighted averages
**Version**: Flink 2.2.0

---

## Definition (Engineering Language)

**Source Weighting**: Assigning credibility weights to news sources to account for their reliability. More credible sources have higher weights.

**Source Credibility Weights**: Numerical values [0, 1] assigned to sources. Reuters=1.0 (most credible), Bloomberg=0.9, others=0.7.

**Article Score**: The keyword score for a single article (from section 12.3). Calculated as SUM(keyword_weight × keyword_count).

**Source-Weighted Signal**: The final signal value per market per window. Calculated as AVG(article_score × source_weight) over all articles in the window.

**Formula**: `source_weighted_signal = AVG(article_score × source_weight)`

---

## Plain Language Explanation

将 source weighting 想象成可信度评级：

- **Source Weights** = 可信度分数：Reuters=1.0（最受信任）、Bloomberg=0.9、others=0.7
- **Article Score** = 文章有多重要（来自 keyword scoring）
- **Weighted Score** = 文章重要性 × Source credibility
- **Final Signal** = 窗口中所有加权分数的平均值

**为什么需要**：并非所有新闻来源都同样可信。MarketLag 按 source credibility 对文章进行加权，以产生更可靠的 signals。

---

## Analogy

如果您了解 **weighted averages**（您了解），source weighting 类似：
- Weighted average = Source-weighted signal（都按重要性加权）
- Item value = Article score（都是要加权的值）
- Weight = Source credibility（都是权重）

关键区别：Source weighting 应用于时间窗口上的流数据。

---

## Relationship to Already Learned Topics

- **12.3 Keyword Scoring**：Article scores 来自 keyword scoring
- **3.1 Window Functions**：Signals 在窗口上聚合
- **12.2 Confidence Score**：Source weight 是 confidence 计算中的因子
- **Weighted Averages**：您已经了解加权平均值 - 这应用了它们

---

## Pseudocode (From Project Design)

Based on MarketLag project design:

```sql
-- Source-weighted signal calculation (simplified)
SELECT
    market_slug,
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start,
    AVG(article_score * source_weight) as source_weighted_signal
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

---

## Source Code References

**Project Design**: `generation_pipeline/step1_output_project_design/output_project_design_v5.md`

**Implementation**: This is implemented in MarketLag Job 1 Flink SQL query.

---

## Source Credibility Weights

### Weight Assignment

**Weights**:
- **Reuters**: 1.0 (most credible, gold standard)
- **Bloomberg**: 0.9 (highly credible, slightly less than Reuters)
- **Others**: 0.7 (default for other sources)

### Why These Weights?

1. **Reuters**: Established, trusted financial news source
2. **Bloomberg**: Also highly credible, but slightly less than Reuters
3. **Others**: Default weight for unknown or less credible sources

**MarketLag**: Uses these weights to account for source reliability.

---

## Article Score: SUM(keyword_scores for that article)

### From Keyword Scoring (Section 12.3)

Article score is calculated from keyword scoring:

```
article_score = SUM(keyword_weight × keyword_count) for all keywords
```

**Example**:
- Article: "Fed raises rates. Fed officials signal more hikes."
- Article score: 7.5 (from section 12.3 example)

**MarketLag**: Article scores are calculated in RSS producer (Lambda) and included in Kafka messages.

---

## Source-Weighted Signal: SUM(article_score × source_weight) / COUNT(*) per Window

### Formula

```
source_weighted_signal = AVG(article_score × source_weight)
```

**Alternative Formulation**:
```
source_weighted_signal = SUM(article_score × source_weight) / COUNT(*)
```

Both are equivalent - AVG is clearer in SQL.

### MarketLag Job 1 Implementation

```sql
SELECT
    market_slug,
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start,
    TUMBLE_END(published_at, INTERVAL '1' HOUR) as window_end,
    COUNT(*) as mention_count,
    SUM(keyword_score) as keyword_score,
    AVG(article_score * source_weight) as source_weighted_signal
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

**This is the exact pattern used in MarketLag Job 1**.

---

## Example Calculation

### Window Data

**Window**: 2024-01-15 14:00:00 to 15:00:00

**Articles**:
1. Reuters: article_score=7.5, source_weight=1.0 → weighted=7.5
2. Bloomberg: article_score=5.0, source_weight=0.9 → weighted=4.5
3. Others: article_score=3.0, source_weight=0.7 → weighted=2.1

### Calculation

```
source_weighted_signal = AVG(7.5, 4.5, 2.1)
                       = (7.5 + 4.5 + 2.1) / 3
                       = 14.1 / 3
                       = 4.7
```

**Result**: source_weighted_signal = 4.7 for this window.

---

## Minimum Viable Code

```sql
-- MarketLag Job 1: Source-weighted signal calculation
CREATE TABLE rss_events (
    market_slug STRING,
    published_at TIMESTAMP(3),
    article_score DOUBLE,
    source_weight DOUBLE,
    source STRING,
    WATERMARK FOR published_at AS published_at - INTERVAL '5' MINUTE
) WITH (
    'connector' = 'kafka',
    'topic' = 'rss.events',
    'format' = 'json'
);

-- Calculate source-weighted signal
SELECT
    market_slug,
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start,
    TUMBLE_END(published_at, INTERVAL '1' HOUR) as window_end,
    COUNT(*) as mention_count,
    SUM(article_score) as keyword_score,
    AVG(article_score * source_weight) as source_weighted_signal
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

---

## Common Mistakes

1. **不按 source 加权**：
   - ❌ 使用原始 article scores 而不进行 source weighting
   - ✅ 始终加权：`AVG(article_score * source_weight)`

2. **错误的聚合**：
   - ❌ 使用 SUM 而不是 AVG
   - ✅ 对平均 signal 使用 AVG：`AVG(article_score * source_weight)`

3. **缺少 source_weight**：
   - ❌ 不在 Kafka 消息中包含 source_weight
   - ✅ 在 RSS producer（Lambda）中包含 source_weight

4. **错误的权重**：
   - ❌ 对所有 sources 使用相等权重
   - ✅ 使用基于可信度的权重（Reuters=1.0、Bloomberg=0.9、others=0.7）

5. **不理解公式**：
   - ❌ 混淆 SUM 与 AVG
   - ✅ 理解：AVG = SUM / COUNT（两者等价）

---

## Mind Trigger: When to Think About This

在以下情况下考虑 source weighting：
- **实现 Job 1**：MarketLag Job 1 计算 source-weighted signals
- **设计权重**：选择适当的 source credibility 权重
- **聚合 signals**：理解 signals 如何在窗口上聚合
- **Confidence 计算**：第 12.2 节在 confidence 公式中使用 source_weight
- **Signal 质量**：Source weighting 提高 signal 可靠性

**在 MarketLag 项目中**：Job 1 通过在窗口上平均 (article_score × source_weight) 来计算 source-weighted signals。这在 signal 计算中考虑了 source credibility。理解 source weighting 对 signal 生成至关重要。

---

## Summary

Source weighting 在 signal 计算中考虑 source credibility。Source credibility 权重：Reuters=1.0、Bloomberg=0.9、others=0.7。Article scores 来自 keyword scoring（第 12.3 节）。Source-weighted signal = 窗口上的 AVG(article_score × source_weight)。MarketLag Job 1 实现此模式。理解 source weighting 对可靠的 signal 生成至关重要。

