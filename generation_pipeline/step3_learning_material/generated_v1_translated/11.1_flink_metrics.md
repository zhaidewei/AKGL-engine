# Flink Metrics

**Learning Point**: 11.1 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 6.4 (Confluent Cloud Monitoring), understanding of metrics
**Version**: Flink 2.2.0

---

## Definition (Engineering Language)

**Flink Metrics**：提供 Flink 作业性能、健康状态和行为洞察的内置和自定义指标。

**Built-in Metrics**：Flink 提供的指标，包括 throughput（记录/秒）、latency（端到端延迟）、checkpoint duration 和 state size。

**Custom Metrics**：用于特定领域监控的用户定义指标（counters、gauges、histograms）。

**Metrics Export**：将 Flink metrics 发送到外部系统（Prometheus、InfluxDB）进行监控和告警。

**Metrics Types**：Counters（递增值）、Gauges（当前值）、Histograms（值分布）。

---

## Plain Language Explanation

将 Flink metrics 想象成汽车的仪表盘：

- **Built-in Metrics** = 标准仪表："速度、燃油水平、发动机温度"
- **Custom Metrics** = 自定义仪表："您的特定测量值"
- **Metrics Export** = 仪表盘显示："在监控仪表盘上显示指标"

**为什么需要**：MarketLag 需要通过 metrics 监控作业性能和健康状态。

---

## Analogy

如果您了解 **application metrics**（您了解），Flink metrics 类似：
- Application metrics = Flink metrics（都跟踪性能）
- Prometheus = Metrics export（都导出到监控系统）
- Custom metrics = Domain metrics（都跟踪业务特定指标）

关键区别：Flink metrics 内置于框架中，自动收集。

---

## Relationship to Already Learned Topics

- **6.4 Confluent Cloud Monitoring**: Confluent Cloud 提供 Flink metrics
- **11.2 Grafana**: Metrics 在 Grafana dashboards 中可视化
- **Monitoring**: 您已经了解监控 - Flink metrics 扩展了它

---

## Built-in Metrics: Throughput, Latency, Checkpoint Duration

### Throughput

**Metric**: `numRecordsInPerSecond`, `numRecordsOutPerSecond`

**含义**：每秒处理的记录数。

**为什么重要**：指示作业性能。低吞吐量可能表示存在反压。

**MarketLag**：监控所有三个作业的吞吐量。

### Latency

**Metric**: `latency` (p50, p95, p99)

**含义**：从 source 到 sink 的端到端延迟。

**为什么重要**：低延迟对实时系统至关重要。

**MarketLag**：监控延迟以确保 lag detection 及时。

### Checkpoint Duration

**Metric**: `checkpointDuration`

**含义**：创建 checkpoint 所需的时间。

**为什么重要**：checkpoint 持续时间过长可能表示状态过大或存在反压。

**MarketLag**：监控 checkpoint 持续时间（目标：5 分钟间隔内 < 1 分钟）。

---

## Custom Metrics: Registering Custom Counters, Gauges

### Custom Counter

```java
import org.apache.flink.metrics.Counter;

public class MyProcessFunction extends KeyedProcessFunction<String, Event, Result> {
    private transient Counter lagDetectedCounter;

    @Override
    public void open(Configuration config) {
        lagDetectedCounter = getRuntimeContext()
            .getMetricGroup()
            .counter("lag_detected_count");
    }

    @Override
    public void processElement(Event event, Context ctx, Collector<Result> out) {
        if (isLagDetected(event)) {
            lagDetectedCounter.inc();  // Increment counter
            out.collect(new LagSignal(event));
        }
    }
}
```

**MarketLag**：可以使用 custom counters 跟踪 lag detection 计数。

### Custom Gauge

```java
import org.apache.flink.metrics.Gauge;

public class MyProcessFunction extends KeyedProcessFunction<String, Event, Result> {
    private transient Gauge<Double> maxSignalDeltaGauge;
    private double currentMax = 0.0;

    @Override
    public void open(Configuration config) {
        maxSignalDeltaGauge = getRuntimeContext()
            .getMetricGroup()
            .gauge("max_signal_delta", new Gauge<Double>() {
                @Override
                public Double getValue() {
                    return currentMax;
                }
            });
    }
}
```

**MarketLag**：可以使用 custom gauges 跟踪 max_signal_delta 值。

---

## Metrics Export: Prometheus, InfluxDB

### Prometheus Export

**Configuration**:
```yaml
metrics.reporter.prometheus.class: org.apache.flink.metrics.prometheus.PrometheusReporter
metrics.reporter.prometheus.port: 9249
```

**访问**：`http://flink-jobmanager:9249/metrics`

**MarketLag**：可以将 metrics 导出到 Prometheus 以在 Grafana 中可视化。

### InfluxDB Export

**Configuration**:
```yaml
metrics.reporter.influxdb.class: org.apache.flink.metrics.influxdb.InfluxdbReporter
metrics.reporter.influxdb.host: localhost
metrics.reporter.influxdb.port: 8086
```

**MarketLag**：可以将 metrics 导出到 InfluxDB 进行时间序列存储。

---

## Minimum Viable Code

```java
import org.apache.flink.metrics.Counter;
import org.apache.flink.metrics.Gauge;
import org.apache.flink.streaming.api.functions.ProcessFunction;

public class MetricsDemo {
    public static class MetricsProcessFunction extends ProcessFunction<Event, Result> {
        private transient Counter processedCounter;
        private transient Counter errorCounter;
        private transient Gauge<Long> stateSizeGauge;

        @Override
        public void open(Configuration config) {
            // Custom counter
            processedCounter = getRuntimeContext()
                .getMetricGroup()
                .counter("records_processed");

            // Custom counter for errors
            errorCounter = getRuntimeContext()
                .getMetricGroup()
                .counter("errors");

            // Custom gauge
            stateSizeGauge = getRuntimeContext()
                .getMetricGroup()
                .gauge("state_size", () -> getStateSize());
        }

        @Override
        public void processElement(Event event, Context ctx, Collector<Result> out) {
            try {
                processRecord(event);
                processedCounter.inc();
            } catch (Exception e) {
                errorCounter.inc();
            }
        }

        private long getStateSize() {
            // Calculate state size
            return 0L;
        }
    }
}
```

---

## Common Mistakes

1. **不监控 metrics**：
   - ❌ 不监控 metrics，问题未被发现
   - ✅ 监控关键 metrics（throughput、latency、checkpoints）

2. **自定义 metrics 过多**：
   - ❌ 创建过多 metrics（开销）
   - ✅ 仅创建必要的 custom metrics

3. **不导出 metrics**：
   - ❌ Metrics 仅在 Flink UI 中（不可访问）
   - ✅ 导出到 Prometheus/InfluxDB 进行监控

4. **不设置告警**：
   - ❌ 收集了 metrics 但没有告警
   - ✅ 在关键 metrics 上设置告警

5. **不理解 metric 语义**：
   - ❌ 误解 metric 值
   - ✅ 理解每个 metric 的含义

---

## Mind Trigger: When to Think About This

在以下情况下考虑 Flink metrics：
- **监控作业**：MarketLag 监控所有三个作业
- **性能调优**：Metrics 帮助识别瓶颈
- **故障排除**：Metrics 帮助诊断问题
- **Grafana dashboards**：第 11.2 节涵盖 Grafana 可视化
- **告警**：第 11.3 节涵盖基于 metrics 的告警

**在 MarketLag 项目中**：监控 built-in metrics（throughput、latency、checkpoint duration），可以添加 custom metrics（lag detection count）。将 metrics 导出到 Prometheus 以在 Grafana 中可视化。理解 Flink metrics 对监控和运维至关重要。

---

## Summary

Flink metrics 提供作业性能和健康状态的洞察。Built-in metrics 包括 throughput、latency 和 checkpoint duration。Custom metrics（counters、gauges）跟踪特定领域的 metrics。将 metrics 导出到 Prometheus 或 InfluxDB 进行监控。MarketLag 监控所有作业的 metrics。理解 Flink metrics 对监控和运维至关重要。

