# Source Weighting and Signal Calculation

**Learning Point**: 12.4 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 12.3 (Keyword Scoring), 3.1 (Window Functions), understanding of weighted averages
**Version**: Flink 2.2.0

---

## Definition (Engineering Language)

**Source Weighting**: Assigning credibility weights to news sources to account for their reliability. More credible sources have higher weights.

**Source Credibility Weights**: Numerical values [0, 1] assigned to sources. Reuters=1.0 (most credible), Bloomberg=0.9, others=0.7.

**Article Score**: The keyword score for a single article (from section 12.3). Calculated as SUM(keyword_weight × keyword_count).

**Source-Weighted Signal**: The final signal value per market per window. Calculated as AVG(article_score × source_weight) over all articles in the window.

**Formula**: `source_weighted_signal = AVG(article_score × source_weight)`

---

## Plain Language Explanation

Think of source weighting like credibility ratings:

- **Source Weights** = Credibility scores: Reuters=1.0 (most trusted), Bloomberg=0.9, others=0.7
- **Article Score** = How important the article is (from keyword scoring)
- **Weighted Score** = Article importance × Source credibility
- **Final Signal** = Average of all weighted scores in the window

**Why Needed**: Not all news sources are equally credible. MarketLag weights articles by source credibility to produce more reliable signals.

---

## Analogy

If you know **weighted averages** (which you do), source weighting is similar:
- Weighted average = Source-weighted signal (both weight by importance)
- Item value = Article score (both are values to weight)
- Weight = Source credibility (both are weights)

Key difference: Source weighting applies to streaming data over time windows.

---

## Relationship to Already Learned Topics

- **12.3 Keyword Scoring**: Article scores come from keyword scoring
- **3.1 Window Functions**: Signals aggregated over windows
- **12.2 Confidence Score**: Source weight is factor in confidence calculation
- **Weighted Averages**: You already know weighted averages - this applies them

---

## Pseudocode (From Project Design)

Based on MarketLag project design:

```sql
-- Source-weighted signal calculation (simplified)
SELECT
    market_slug,
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start,
    AVG(article_score * source_weight) as source_weighted_signal
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

---

## Source Code References

**Project Design**: `generation_pipeline/step1_output_project_design/output_project_design_v5.md`

**Implementation**: This is implemented in MarketLag Job 1 Flink SQL query.

---

## Source Credibility Weights

### Weight Assignment

**Weights**:
- **Reuters**: 1.0 (most credible, gold standard)
- **Bloomberg**: 0.9 (highly credible, slightly less than Reuters)
- **Others**: 0.7 (default for other sources)

### Why These Weights?

1. **Reuters**: Established, trusted financial news source
2. **Bloomberg**: Also highly credible, but slightly less than Reuters
3. **Others**: Default weight for unknown or less credible sources

**MarketLag**: Uses these weights to account for source reliability.

---

## Article Score: SUM(keyword_scores for that article)

### From Keyword Scoring (Section 12.3)

Article score is calculated from keyword scoring:

```
article_score = SUM(keyword_weight × keyword_count) for all keywords
```

**Example**:
- Article: "Fed raises rates. Fed officials signal more hikes."
- Article score: 7.5 (from section 12.3 example)

**MarketLag**: Article scores are calculated in RSS producer (Lambda) and included in Kafka messages.

---

## Source-Weighted Signal: SUM(article_score × source_weight) / COUNT(*) per Window

### Formula

```
source_weighted_signal = AVG(article_score × source_weight)
```

**Alternative Formulation**:
```
source_weighted_signal = SUM(article_score × source_weight) / COUNT(*)
```

Both are equivalent - AVG is clearer in SQL.

### MarketLag Job 1 Implementation

```sql
SELECT
    market_slug,
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start,
    TUMBLE_END(published_at, INTERVAL '1' HOUR) as window_end,
    COUNT(*) as mention_count,
    SUM(keyword_score) as keyword_score,
    AVG(article_score * source_weight) as source_weighted_signal
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

**This is the exact pattern used in MarketLag Job 1**.

---

## Example Calculation

### Window Data

**Window**: 2024-01-15 14:00:00 to 15:00:00

**Articles**:
1. Reuters: article_score=7.5, source_weight=1.0 → weighted=7.5
2. Bloomberg: article_score=5.0, source_weight=0.9 → weighted=4.5
3. Others: article_score=3.0, source_weight=0.7 → weighted=2.1

### Calculation

```
source_weighted_signal = AVG(7.5, 4.5, 2.1)
                       = (7.5 + 4.5 + 2.1) / 3
                       = 14.1 / 3
                       = 4.7
```

**Result**: source_weighted_signal = 4.7 for this window.

---

## Minimum Viable Code

```sql
-- MarketLag Job 1: Source-weighted signal calculation
CREATE TABLE rss_events (
    market_slug STRING,
    published_at TIMESTAMP(3),
    article_score DOUBLE,
    source_weight DOUBLE,
    source STRING,
    WATERMARK FOR published_at AS published_at - INTERVAL '5' MINUTE
) WITH (
    'connector' = 'kafka',
    'topic' = 'rss.events',
    'format' = 'json'
);

-- Calculate source-weighted signal
SELECT
    market_slug,
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start,
    TUMBLE_END(published_at, INTERVAL '1' HOUR) as window_end,
    COUNT(*) as mention_count,
    SUM(article_score) as keyword_score,
    AVG(article_score * source_weight) as source_weighted_signal
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

---

## Common Mistakes

1. **Not weighting by source**:
   - ❌ Using raw article scores without source weighting
   - ✅ Always weight: `AVG(article_score * source_weight)`

2. **Wrong aggregation**:
   - ❌ Using SUM instead of AVG
   - ✅ Use AVG for average signal: `AVG(article_score * source_weight)`

3. **Missing source_weight**:
   - ❌ Not including source_weight in Kafka messages
   - ✅ Include source_weight in RSS producer (Lambda)

4. **Wrong weights**:
   - ❌ Using equal weights for all sources
   - ✅ Use credibility-based weights (Reuters=1.0, Bloomberg=0.9, others=0.7)

5. **Not understanding formula**:
   - ❌ Confusing SUM vs AVG
   - ✅ Understand: AVG = SUM / COUNT (both equivalent)

---

## Mind Trigger: When to Think About This

Think about source weighting when:
- **Implementing Job 1**: MarketLag Job 1 calculates source-weighted signals
- **Designing weights**: Choosing appropriate source credibility weights
- **Aggregating signals**: Understanding how signals are aggregated over windows
- **Confidence calculation**: Section 12.2 uses source_weight in confidence formula
- **Signal quality**: Source weighting improves signal reliability

**In MarketLag project**: Job 1 calculates source-weighted signals by averaging (article_score × source_weight) over windows. This accounts for source credibility in signal calculation. Understanding source weighting is essential for signal generation.

---

## Summary

Source weighting accounts for source credibility in signal calculation. Source credibility weights: Reuters=1.0, Bloomberg=0.9, others=0.7. Article scores come from keyword scoring (section 12.3). Source-weighted signal = AVG(article_score × source_weight) over window. MarketLag Job 1 implements this pattern. Understanding source weighting is essential for reliable signal generation.

