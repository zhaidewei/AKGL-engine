# Lag Detection Algorithm

**Learning Point**: 12.1 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 3.3 (Equi-Join), 3.4 (LAG function), understanding of signal processing
**Version**: Flink 2.2.0

---

## Definition (Engineering Language)

**Lag Detection Algorithm**: The core business logic of MarketLag project that identifies when information (RSS signals) changes significantly but market prices (Polymarket) do not respond, indicating a potential information lag.

**Signal Delta**: The change in RSS signal between two consecutive time windows. Calculated as `signal(t) - signal(t-1)`.

**Price Delta**: The change in Polymarket price between two consecutive time windows. Calculated as `price(t) - price(t-1)`.

**Lag Flag**: Boolean indicator that a lag has been detected. True when `signal_delta > 1.0 AND abs(price_delta) < 0.02`.

**Threshold Values**:
- Signal delta threshold: 1.0 (signal increased by at least 1.0)
- Price delta threshold: 0.02 (price changed by less than 2%)

---

## Plain Language Explanation

Think of lag detection like a traffic light system:

- **Signal Delta** = Information change: "News mentions increased significantly"
- **Price Delta** = Market reaction: "But price didn't move much"
- **Lag Flag** = Alert: "There's a lag - information changed but market didn't react"

**The Algorithm**: If information changes a lot (signal_delta > 1.0) but price doesn't change much (abs(price_delta) < 0.02), flag it as a potential lag.

---

## Analogy

Imagine you're monitoring a stock:
- **Signal Delta** = Breaking news about the company (big change)
- **Price Delta** = Stock price movement (small change)
- **Lag** = News broke but stock price hasn't reacted yet (opportunity)

MarketLag detects this lag between information and market reaction.

---

## Relationship to Already Learned Topics

- **3.3 Equi-Join**: Joins RSS signals with prices (prerequisite for lag detection)
- **3.4 LAG Function**: Calculates signal_delta using LAG
- **12.2 Confidence Score**: Quantifies reliability of lag signals
- **Signal Processing**: Core algorithm for the entire project

---

## Pseudocode (From Project Design)

Based on MarketLag project design:

```sql
-- Lag detection algorithm (simplified)
WITH joined_data AS (
    SELECT
        market_slug,
        window_start,
        rss_signal,
        price,
        price_delta,
        -- Calculate signal_delta using LAG
        (rss_signal - LAG(rss_signal)
         OVER (PARTITION BY market_slug ORDER BY window_start)) as signal_delta
    FROM rss_signals_hourly r
    INNER JOIN polymarket_price_hourly p
    ON r.market_slug = p.market_slug
      AND r.window_start = p.event_time
)
SELECT
    market_slug,
    window_start,
    signal_delta,
    price_delta,
    -- Lag detection logic
    CASE
        WHEN signal_delta > 1.0 AND ABS(price_delta) < 0.02
        THEN true
        ELSE false
    END as lag_flag
FROM joined_data;
```

---

## Source Code References

**Project Design**: `generation_pipeline/step1_output_project_design/output_project_design_v5.md`

**Implementation**: This algorithm is implemented in MarketLag Job 3 Flink SQL query.

---

## Signal Delta Calculation: signal(t) - signal(t-1)

### Formula

```
signal_delta = signal(current_window) - signal(previous_window)
```

### Implementation in Flink SQL

```sql
(rss_signal - LAG(rss_signal)
 OVER (PARTITION BY market_slug ORDER BY window_start)) as signal_delta
```

**How It Works**:
1. **LAG function**: Gets previous window's signal value
2. **PARTITION BY market_slug**: Calculate delta per market (not across markets)
3. **ORDER BY window_start**: Order by time to get previous window
4. **Subtraction**: Current - Previous = Delta

**Example**:
- Window 1 (14:00): signal = 2.5
- Window 2 (15:00): signal = 4.0
- signal_delta = 4.0 - 2.5 = 1.5

---

## Price Delta Comparison: abs(price_delta) < threshold (0.02 = 2%)

### Formula

```
abs(price_delta) < 0.02
```

**Threshold**: 0.02 = 2% price change

### Why This Threshold?

- **Small Change**: Price changed by less than 2%
- **Stable Price**: Market didn't react significantly
- **Lag Indicator**: Information changed but price didn't

**Example**:
- Previous price: 0.50
- Current price: 0.51
- price_delta = 0.01
- abs(price_delta) = 0.01 < 0.02 ✓ (price stable)

---

## Lag Flag Logic: signal_delta > 1.0 AND abs(price_delta) < 0.02

### Complete Logic

```sql
CASE
    WHEN signal_delta > 1.0 AND ABS(price_delta) < 0.02
    THEN true
    ELSE false
END as lag_flag
```

### Conditions

1. **signal_delta > 1.0**: Information changed significantly (signal increased by at least 1.0)
2. **abs(price_delta) < 0.02**: Price didn't change much (less than 2% change)

**Both conditions must be true** for lag_flag = true.

### Example Scenarios

**Scenario 1: Lag Detected** ✓
- signal_delta = 1.5 (> 1.0 ✓)
- price_delta = 0.01 (abs < 0.02 ✓)
- lag_flag = true

**Scenario 2: No Lag** ✗
- signal_delta = 0.5 (< 1.0 ✗)
- price_delta = 0.01
- lag_flag = false

**Scenario 3: No Lag (Price Reacted)** ✗
- signal_delta = 1.5 (> 1.0 ✓)
- price_delta = 0.05 (abs > 0.02 ✗)
- lag_flag = false

---

## MarketLag Job 3 Implementation

```sql
SELECT
    r.market_slug,
    r.window_start,
    r.source_weighted_signal as rss_signal,
    p.price,
    p.price_delta,
    -- Calculate signal_delta
    (r.source_weighted_signal - LAG(r.source_weighted_signal)
      OVER (PARTITION BY r.market_slug ORDER BY r.window_start)) as signal_delta,
    -- Lag detection
    CASE
        WHEN (r.source_weighted_signal - LAG(r.source_weighted_signal)
              OVER (PARTITION BY r.market_slug ORDER BY r.window_start)) > 1.0
          AND ABS(p.price_delta) < 0.02
        THEN true
        ELSE false
    END as lag_flag
FROM rss_signals_hourly r
INNER JOIN polymarket_price_hourly p
ON r.market_slug = p.market_slug
  AND r.window_start = p.event_time
WHERE r.source_weighted_signal IS NOT NULL
  AND p.price IS NOT NULL;
```

---

## Minimum Viable Code

```sql
-- Simplified lag detection
WITH signals AS (
    SELECT
        market_slug,
        window_start,
        signal,
        LAG(signal) OVER (PARTITION BY market_slug ORDER BY window_start) as prev_signal
    FROM rss_signals_hourly
),
prices AS (
    SELECT
        market_slug,
        event_time,
        price,
        price_delta
    FROM polymarket_price_hourly
),
joined AS (
    SELECT
        s.market_slug,
        s.window_start,
        s.signal - s.prev_signal as signal_delta,
        p.price_delta
    FROM signals s
    INNER JOIN prices p
    ON s.market_slug = p.market_slug
      AND s.window_start = p.event_time
)
SELECT
    market_slug,
    window_start,
    signal_delta,
    price_delta,
    CASE
        WHEN signal_delta > 1.0 AND ABS(price_delta) < 0.02
        THEN true
        ELSE false
    END as lag_flag
FROM joined;
```

---

## Common Mistakes

1. **Wrong LAG window**:
   - ❌ LAG without PARTITION BY (mixes markets)
   - ✅ Always use PARTITION BY market_slug

2. **Wrong threshold values**:
   - ❌ Using different thresholds without understanding
   - ✅ Understand why 1.0 and 0.02 are chosen (tunable parameters)

3. **Missing NULL handling**:
   - ❌ LAG returns NULL for first window (causes errors)
   - ✅ Handle NULL: `COALESCE(LAG(...), 0)`

4. **Not understanding AND logic**:
   - ❌ Thinking OR instead of AND
   - ✅ Both conditions must be true (signal up AND price stable)

5. **Price delta already calculated**:
   - ❌ Recalculating price_delta in Flink
   - ✅ price_delta is calculated in Lambda producer (section 7.4)

---

## Mind Trigger: When to Think About This

Think about lag detection algorithm when:
- **Implementing Job 3**: Core logic of MarketLag project
- **Tuning thresholds**: 1.0 and 0.02 are tunable parameters
- **Understanding business logic**: This is what the entire project detects
- **Debugging lag signals**: Understanding algorithm helps debug false positives
- **Confidence scoring**: Section 12.2 uses lag detection results

**In MarketLag project**: This is the core algorithm implemented in Job 3. Detects when RSS signals increase significantly but Polymarket prices don't react, indicating information lag. Results are stored in Supabase with confidence scores (section 12.2).

---

## Summary

Lag detection algorithm identifies when information (RSS signals) changes significantly but market prices don't react. Signal delta (signal(t) - signal(t-1)) measures information change. Price delta measures market reaction. Lag flag is true when signal_delta > 1.0 AND abs(price_delta) < 0.02. This is the core business logic of MarketLag project, implemented in Job 3 Flink SQL query.

