# Grafana Dashboard Creation

**Learning Point**: 11.2 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 11.1 (Flink Metrics), 5.1 (JDBC Connector), SQL knowledge
**Version**: Grafana, PostgreSQL

---

## Definition (Engineering Language)

**Grafana Dashboard Creation**: Building visualization dashboards in Grafana to monitor MarketLag system health and lag signals.

**Grafana Data Source Configuration**: Connecting Grafana to data sources (PostgreSQL for lag signals, Prometheus for Flink metrics).

**Panel Types**: Time series (line charts), histogram (distribution), scatter plot (correlations), table (tabular data).

**SQL Query Example**: Querying lag_signals_history table to visualize lag detection over time.

**Dashboard Organization**: Organizing panels into logical groups (lag signals, system health, job metrics).

---

## Plain Language Explanation

Think of Grafana dashboard like a control room:

- **Dashboard** = Control room: "See everything at once"
- **Panels** = Monitors: "Each panel shows different information"
- **Data Sources** = Information feeds: "Where data comes from (PostgreSQL, Prometheus)"

**Why Needed**: MarketLag visualizes lag signals and system health in Grafana for monitoring and analysis.

---

## Analogy

If you know **dashboard tools** (which you do), Grafana is similar:
- Tableau/Power BI = Grafana (both create dashboards)
- Data sources = Database connections (both connect to data)
- Panels = Charts/visualizations (both visualize data)

Key difference: Grafana specializes in time-series and operational monitoring.

---

## Relationship to Already Learned Topics

- **11.1 Flink Metrics**: Metrics visualized in Grafana
- **5.1 JDBC Connector**: Lag signals stored in PostgreSQL, queried by Grafana
- **SQL**: You already know SQL - Grafana uses SQL queries
- **Monitoring**: You already know monitoring dashboards

---

## Grafana Data Source Configuration: PostgreSQL, Prometheus

### PostgreSQL Data Source

**Configuration**:
- **Type**: PostgreSQL
- **Host**: Supabase PostgreSQL endpoint
- **Database**: postgres
- **User**: postgres
- **Password**: (from environment)

**MarketLag**: Connects to Supabase PostgreSQL to query lag_signals_history.

### Prometheus Data Source

**Configuration**:
- **Type**: Prometheus
- **URL**: Prometheus endpoint (if Flink metrics exported to Prometheus)

**MarketLag**: Can connect to Prometheus for Flink job metrics.

---

## Panel Types: Time Series, Histogram, Scatter Plot, Table

### Time Series Panel

**Use Case**: Show lag signal count over time.

**Example**: Hourly lag signal count.

**MarketLag**: Uses time series to visualize lag detection trends.

### Histogram Panel

**Use Case**: Show distribution of confidence scores.

**Example**: Confidence score distribution.

**MarketLag**: Can visualize confidence score distribution.

### Scatter Plot Panel

**Use Case**: Show correlation between signal_delta and price_delta.

**Example**: signal_delta vs price_delta scatter plot.

**MarketLag**: Can visualize signal-price relationships.

### Table Panel

**Use Case**: Show recent lag signals in tabular format.

**Example**: Last 100 lag signals with details.

**MarketLag**: Uses tables to show recent lag detections.

---

## SQL Query Example (Hourly Aggregation)

### Query for Time Series Panel

```sql
SELECT
    date_trunc('hour', detected_at) as hour,
    COUNT(*) as lag_count
FROM lag_signals_history
WHERE lag_flag = true
  AND detected_at >= NOW() - INTERVAL '24 hours'
GROUP BY date_trunc('hour', detected_at)
ORDER BY hour
```

**MarketLag**: Uses this query to visualize hourly lag signal count.

### Query for Confidence Distribution

```sql
SELECT
    CASE
        WHEN confidence < 0.5 THEN 'Low'
        WHEN confidence < 0.8 THEN 'Medium'
        ELSE 'High'
    END as confidence_level,
    COUNT(*) as count
FROM lag_signals_history
WHERE lag_flag = true
GROUP BY confidence_level
```

**MarketLag**: Can use this to visualize confidence distribution.

---

## Dashboard Organization and Layout

### Panel Groups

1. **Lag Signals**: Lag detection metrics and trends
2. **System Health**: Flink job metrics, Kafka metrics
3. **Data Quality**: Error rates, DLQ size, validation failures

**MarketLag**: Organizes dashboard into these groups.

### Layout Example

```
Dashboard: MarketLag Monitoring
├── Lag Signals Section
│   ├── Hourly Lag Count (Time Series)
│   ├── Confidence Distribution (Histogram)
│   └── Recent Lag Signals (Table)
├── System Health Section
│   ├── Flink Job Throughput (Time Series)
│   ├── Checkpoint Success Rate (Time Series)
│   └── Consumer Lag (Time Series)
└── Data Quality Section
    ├── DLQ Size (Time Series)
    └── Validation Errors (Counter)
```

---

## Minimum Viable Code

```sql
-- Grafana SQL Query: Hourly Lag Count
SELECT
    date_trunc('hour', detected_at) as time,
    COUNT(*) as lag_count
FROM lag_signals_history
WHERE lag_flag = true
  AND detected_at >= $__timeFrom()
  AND detected_at <= $__timeTo()
GROUP BY date_trunc('hour', detected_at)
ORDER BY time

-- Grafana SQL Query: Confidence Score Distribution
SELECT
    confidence,
    COUNT(*) as count
FROM lag_signals_history
WHERE lag_flag = true
  AND detected_at >= $__timeFrom()
GROUP BY confidence
ORDER BY confidence
```

---

## Common Mistakes

1. **Not using time variables**:
   - ❌ Hardcoding time ranges
   - ✅ Use Grafana time variables: `$__timeFrom()`, `$__timeTo()`

2. **Inefficient queries**:
   - ❌ Querying all data without time filters
   - ✅ Always filter by time range for performance

3. **Not organizing panels**:
   - ❌ All panels in one row (hard to read)
   - ✅ Organize into logical groups

4. **Not setting refresh interval**:
   - ❌ Dashboard doesn't auto-refresh
   - ✅ Set appropriate refresh interval (e.g., 30 seconds)

5. **Not using appropriate panel types**:
   - ❌ Using table for time series data
   - ✅ Use time series panel for time-based data

---

## Mind Trigger: When to Think About This

Think about Grafana dashboard creation when:
- **Visualizing lag signals**: MarketLag visualizes lag detection in Grafana
- **Monitoring system health**: Monitor Flink jobs, Kafka, data quality
- **Creating dashboards**: Organize panels into logical groups
- **SQL queries**: Write SQL queries for PostgreSQL data source
- **Alerting**: Section 11.3 covers alerting based on dashboard metrics

**In MarketLag project**: Creates Grafana dashboards to visualize lag signals (hourly count, confidence distribution) and system health (Flink metrics, Kafka metrics). Uses PostgreSQL data source for lag signals. Understanding Grafana dashboard creation is essential for monitoring and visualization.

---

## Summary

Grafana dashboard creation enables visualization of MarketLag system health and lag signals. Configure data sources (PostgreSQL, Prometheus). Use panel types (time series, histogram, scatter plot, table). Write SQL queries for data visualization. Organize dashboard into logical groups. MarketLag visualizes lag signals and system health in Grafana. Understanding Grafana dashboard creation is essential for monitoring and visualization.

