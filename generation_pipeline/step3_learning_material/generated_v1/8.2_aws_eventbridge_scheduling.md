# AWS EventBridge Scheduling

**Learning Point**: 8.2 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 8.1 (AWS Lambda), understanding of cron expressions
**Version**: AWS EventBridge

---

## Definition (Engineering Language)

**AWS EventBridge Scheduling**: Using AWS EventBridge to trigger Lambda functions on a schedule using cron expressions or rate expressions.

**EventBridge Rule**: Defines when and how to trigger targets (Lambda functions). Uses cron expressions for time-based scheduling.

**Cron Expression**: String format defining schedule (e.g., `*/15 * * * ? *` = every 15 minutes).

**EventBridge Target**: The resource to trigger (Lambda function in MarketLag case).

**Target Configuration**: Settings for how to invoke the target (input transformation, retry policy, etc.).

---

## Plain Language Explanation

Think of EventBridge like an alarm clock:

- **EventBridge Rule** = Alarm clock: "Wake me up every 15 minutes"
- **Cron Expression** = Schedule: "*/15 * * * ? *" = every 15 minutes
- **Target** = What to do: "Trigger Lambda function"

**Why Needed**: MarketLag uses EventBridge to trigger RSS producer every 15 minutes and Polymarket producer every hour.

---

## Analogy

If you know **cron jobs** (which you do), EventBridge is similar:
- Cron schedule = EventBridge cron expression (both define schedule)
- Cron command = EventBridge target (both execute something)
- Cron daemon = EventBridge service (both trigger on schedule)

Key difference: EventBridge is serverless, no server to manage.

---

## Relationship to Already Learned Topics

- **8.1 AWS Lambda**: EventBridge triggers Lambda functions
- **7.1 RSS Processing**: RSS producer triggered every 15 minutes
- **7.2 Polymarket API**: Polymarket producer triggered every hour
- **Cron**: You already know cron - EventBridge uses similar syntax

---

## EventBridge Rule Creation: Cron Expressions

### Cron Expression Format

**Format**: `minute hour day-of-month month day-of-week year`

**Example**: `*/15 * * * ? *`
- `*/15` = Every 15 minutes
- `*` = Every hour
- `*` = Every day of month
- `*` = Every month
- `?` = No specific day of week
- `*` = Every year

### MarketLag Cron Expressions

**RSS Producer**: `*/15 * * * ? *` (every 15 minutes)
- Triggers at: :00, :15, :30, :45 of every hour

**Polymarket Producer**: `0 * * * ? *` (every hour at minute 0)
- Triggers at: :00 of every hour (1:00, 2:00, 3:00, etc.)

---

## RSS Producer Cron: `*/15 * * * ? *` (Every 15 Minutes)

### Schedule

**Expression**: `*/15 * * * ? *`

**Triggers**: Every 15 minutes
- 00:00, 00:15, 00:30, 00:45
- 01:00, 01:15, 01:30, 01:45
- etc.

**Why 15 Minutes**:
- Balance between freshness and rate limiting
- RSS feeds don't update every minute
- Avoids hitting RSS.app rate limits

**MarketLag**: Uses this schedule for RSS producer.

### EventBridge Rule Configuration

```json
{
  "Name": "rss-producer-schedule",
  "ScheduleExpression": "cron(*/15 * * * ? *)",
  "State": "ENABLED",
  "Targets": [
    {
      "Id": "1",
      "Arn": "arn:aws:lambda:region:account:function:rss-producer",
      "Input": "{}"
    }
  ]
}
```

---

## Polymarket Producer Cron: `0 * * * ? *` (Every Hour at Minute 0)

### Schedule

**Expression**: `0 * * * ? *`

**Triggers**: Every hour at minute 0
- 00:00, 01:00, 02:00, 03:00, etc.

**Why Hourly**:
- Prices don't change every minute
- Hourly is sufficient for lag detection
- Reduces API calls and costs

**MarketLag**: Uses this schedule for Polymarket producer.

### EventBridge Rule Configuration

```json
{
  "Name": "polymarket-producer-schedule",
  "ScheduleExpression": "cron(0 * * * ? *)",
  "State": "ENABLED",
  "Targets": [
    {
      "Id": "1",
      "Arn": "arn:aws:lambda:region:account:function:polymarket-producer",
      "Input": "{}"
    }
  ]
}
```

---

## EventBridge Target Configuration: Lambda Function

### Basic Configuration

**Target Type**: Lambda function

**Target ARN**: Lambda function ARN

**Input**: Event data passed to Lambda (can be static JSON or transformed)

### MarketLag Configuration

```python
# EventBridge rule targets Lambda function
# Input: Empty JSON {} (Lambda doesn't need event data)
# Lambda handler receives event from EventBridge
```

### Lambda Handler Receiving Event

```python
def lambda_handler(event, context):
    """
    Lambda handler triggered by EventBridge.

    Args:
        event: EventBridge event (contains schedule info)
        context: Lambda context
    """
    # Event structure from EventBridge
    # {
    #   "version": "0",
    #   "id": "...",
    #   "detail-type": "Scheduled Event",
    #   "source": "aws.events",
    #   "time": "2024-01-15T14:00:00Z",
    #   "region": "us-east-1",
    #   "resources": ["arn:aws:events:..."],
    #   "detail": {}
    # }

    # Your producer logic
    fetch_and_send_data()

    return {'statusCode': 200}
```

---

## Minimum Viable Code

### EventBridge Rule (AWS Console or CLI)

```bash
# Create EventBridge rule for RSS producer
aws events put-rule \
    --name rss-producer-schedule \
    --schedule-expression "cron(*/15 * * * ? *)" \
    --state ENABLED

# Add Lambda target
aws events put-targets \
    --rule rss-producer-schedule \
    --targets "Id=1,Arn=arn:aws:lambda:region:account:function:rss-producer"
```

### Lambda Function

```python
import json

def lambda_handler(event, context):
    """
    Lambda handler triggered by EventBridge.
    """
    # EventBridge event contains schedule information
    event_time = event.get('time')  # Schedule time

    # Your producer logic
    try:
        # Fetch data (RSS or Polymarket)
        data = fetch_data()

        # Send to Kafka
        send_to_kafka(data)

        return {
            'statusCode': 200,
            'body': json.dumps({'message': 'Success', 'count': len(data)})
        }
    except Exception as e:
        print(f"Error: {e}")
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }
```

---

## Common Mistakes

1. **Wrong cron expression**:
   - ❌ `*/15 * * * *` (missing year field, wrong syntax)
   - ✅ Use EventBridge format: `*/15 * * * ? *`

2. **Not enabling rule**:
   - ❌ Rule created but disabled
   - ✅ Set state to ENABLED

3. **Not adding target**:
   - ❌ Rule created but no Lambda target
   - ✅ Add Lambda function as target

4. **Wrong timezone**:
   - ❌ Cron uses UTC, expecting local time
   - ✅ EventBridge cron uses UTC (convert if needed)

5. **Too frequent scheduling**:
   - ❌ Every minute (hits rate limits, unnecessary)
   - ✅ Use appropriate intervals (15 min for RSS, 1 hour for prices)

---

## Mind Trigger: When to Think About This

Think about EventBridge scheduling when:
- **Scheduling producers**: MarketLag schedules RSS (15 min) and Polymarket (hourly)
- **Creating rules**: Set up EventBridge rules for scheduled tasks
- **Configuring targets**: Add Lambda functions as targets
- **Understanding cron**: EventBridge uses cron expressions
- **Time zones**: EventBridge uses UTC, convert if needed

**In MarketLag project**: Uses EventBridge to trigger RSS producer every 15 minutes and Polymarket producer every hour. Understanding EventBridge scheduling is essential for automated data ingestion.

---

## Summary

AWS EventBridge scheduling triggers Lambda functions on schedule using cron expressions. MarketLag uses `*/15 * * * ? *` for RSS producer (every 15 minutes) and `0 * * * ? *` for Polymarket producer (every hour). EventBridge rules target Lambda functions. Understanding EventBridge scheduling is essential for automated data ingestion.

