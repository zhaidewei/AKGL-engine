# Polymarket API Integration

**Learning Point**: 7.2 from knowledge_and_skills_needed_v2.md
**Prerequisites**: Understanding of REST APIs, JSON parsing, Python basics
**Version**: Polymarket API (current)

---

## Definition (Engineering Language)

**Polymarket API Architecture**: Polymarket uses two separate API systems: Gamma API for market metadata and CLOB API for price data.

**Gamma API**: REST API for retrieving market metadata including market information, token IDs (YES/NO tokens), and market structure.

**CLOB API**: REST API for retrieving price data for specific tokens. Uses POST requests with token IDs to get current prices.

**API Authentication**: MVP uses public endpoints (no authentication required). Production may require API keys.

**Rate Limiting**: API rate limits to prevent abuse. Must implement retry logic with exponential backoff.

---

## Plain Language Explanation

Think of Polymarket API like a two-step lookup:

- **Gamma API** = Directory: "What markets exist? What are the token IDs?"
- **CLOB API** = Price lookup: "What are the current prices for these tokens?"

**Why Two APIs**: Market metadata (structure) changes infrequently, prices change frequently. Separating them optimizes performance.

---

## Analogy

If you know **stock market APIs** (which you do), Polymarket API is similar:
- Market data API = Gamma API (both provide market structure)
- Price API = CLOB API (both provide current prices)

Key difference: Polymarket uses prediction market tokens (YES/NO) instead of stocks.

---

## Relationship to Already Learned Topics

- **8.1 AWS Lambda**: Polymarket API calls run in Lambda functions
- **8.2 EventBridge**: Scheduled triggers for hourly price polling
- **7.4 Price Delta**: Price data used for delta calculation
- **REST APIs**: You already know REST APIs - Polymarket uses standard REST

---

## Polymarket API Architecture: Gamma API vs CLOB API

### Gamma API (Market Metadata)

**Purpose**: Get market structure and token IDs.

**Use Case**: One-time or infrequent calls to get market information.

**MarketLag**: Uses Gamma API to get token IDs for markets.

### CLOB API (Price Data)

**Purpose**: Get current prices for tokens.

**Use Case**: Frequent calls to get latest prices.

**MarketLag**: Uses CLOB API hourly to get current prices.

---

## Gamma API: `GET https://gamma-api.polymarket.com/markets/slug/{slug}`

### Endpoint

**URL**: `GET https://gamma-api.polymarket.com/markets/slug/{slug}`

**Example**: `GET https://gamma-api.polymarket.com/markets/slug/fed-hike-january`

**Method**: GET

**Authentication**: None (public endpoint for MVP)

**Response**: JSON with market metadata

### Response Structure

```json
{
  "slug": "fed-hike-january",
  "question": "Will the Fed raise rates in January?",
  "clobTokenIds": {
    "YES": "0x1234...",
    "NO": "0x5678..."
  },
  "closeTime": "2024-01-31T23:59:59Z"
}
```

### MarketLag Usage

```python
import requests

def get_market_tokens(market_slug):
    """
    Get token IDs for a market.

    Args:
        market_slug: Market slug (e.g., "fed-hike-january")

    Returns:
        dict: Token IDs {"YES": "0x...", "NO": "0x..."}
    """
    url = f"https://gamma-api.polymarket.com/markets/slug/{market_slug}"
    response = requests.get(url)
    data = response.json()

    return data.get('clobTokenIds', {})

# Usage
tokens = get_market_tokens("fed-hike-january")
yes_token = tokens.get("YES")
no_token = tokens.get("NO")
```

**MarketLag**: Calls Gamma API to get token IDs, then uses them in CLOB API.

---

## CLOB API: `POST https://clob.polymarket.com/prices`

### Endpoint

**URL**: `POST https://clob.polymarket.com/prices`

**Method**: POST

**Request Body**: JSON with token IDs
```json
{
  "token_ids": ["0x1234...", "0x5678..."]
}
```

**Authentication**: None (public endpoint for MVP)

**Response**: JSON with prices
```json
{
  "0x1234...": {
    "price": 0.65,
    "side": "BUY"
  },
  "0x5678...": {
    "price": 0.35,
    "side": "BUY"
  }
}
```

### MarketLag Usage

```python
def get_prices(token_ids):
    """
    Get prices for tokens.

    Args:
        token_ids: List of token IDs

    Returns:
        dict: Prices {token_id: price}
    """
    url = "https://clob.polymarket.com/prices"
    payload = {"token_ids": token_ids}

    response = requests.post(url, json=payload)
    data = response.json()

    prices = {}
    for token_id, price_data in data.items():
        prices[token_id] = price_data.get('price', 0.0)

    return prices

# Usage
token_ids = [yes_token, no_token]
prices = get_prices(token_ids)
yes_price = prices.get(yes_token, 0.0)
no_price = prices.get(no_token, 0.0)
```

**MarketLag**: Calls CLOB API hourly to get current prices for YES/NO tokens.

---

## API Authentication: Public Endpoints (MVP)

### MVP: No Authentication

**Current**: Polymarket API public endpoints don't require authentication for MVP.

**Limitations**: May have rate limits, may change in future.

**MarketLag**: Uses public endpoints for MVP.

### Production: API Keys (Future)

**Future**: May require API keys for higher rate limits or additional features.

**Implementation**: Add API key to request headers:
```python
headers = {
    'Authorization': f'Bearer {api_key}'
}
response = requests.get(url, headers=headers)
```

---

## Rate Limiting and Error Handling

### Rate Limiting

**Issue**: API may rate limit requests.

**Solution**: Implement retry with exponential backoff:

```python
import time
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

def get_with_retry(url, max_retries=3):
    """
    Get with exponential backoff retry.
    """
    session = requests.Session()
    retry_strategy = Retry(
        total=max_retries,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504]
    )
    adapter = HTTPAdapter(max_retries=retry_strategy)
    session.mount("http://", adapter)
    session.mount("https://", adapter)

    return session.get(url)

# Usage
response = get_with_retry("https://gamma-api.polymarket.com/markets/slug/fed-hike-january")
```

**MarketLag**: Implements retry logic in Lambda function (section 8.1).

---

## Minimum Viable Code

```python
import requests
from datetime import datetime
import pytz

def fetch_polymarket_price(market_slug):
    """
    Fetch Polymarket price for a market.

    Args:
        market_slug: Market slug (e.g., "fed-hike-january")

    Returns:
        dict: Price data {outcome: price, event_time: timestamp}
    """
    # Step 1: Get token IDs from Gamma API
    gamma_url = f"https://gamma-api.polymarket.com/markets/slug/{market_slug}"
    gamma_response = requests.get(gamma_url)
    gamma_data = gamma_response.json()

    token_ids = gamma_data.get('clobTokenIds', {})
    yes_token = token_ids.get('YES')
    no_token = token_ids.get('NO')

    if not yes_token or not no_token:
        return None

    # Step 2: Get prices from CLOB API
    clob_url = "https://clob.polymarket.com/prices"
    clob_payload = {"token_ids": [yes_token, no_token]}
    clob_response = requests.post(clob_url, json=clob_payload)
    clob_data = clob_response.json()

    # Extract prices
    yes_price = clob_data.get(yes_token, {}).get('price', 0.0)
    no_price = clob_data.get(no_token, {}).get('price', 0.0)

    # Return price data (use YES price as market price)
    return {
        'market_slug': market_slug,
        'outcome': 'YES',
        'price': yes_price,
        'event_time': datetime.now(pytz.UTC).isoformat()
    }

# Usage
price_data = fetch_polymarket_price("fed-hike-january")
```

---

## Common Mistakes

1. **Not handling API errors**:
   - ❌ No error handling, job fails on API errors
   - ✅ Implement retry logic, error handling (section 9.1)

2. **Wrong API endpoint**:
   - ❌ Using Gamma API for prices (wrong API)
   - ✅ Use Gamma API for metadata, CLOB API for prices

3. **Not extracting token IDs**:
   - ❌ Hardcoding token IDs (they may change)
   - ✅ Always fetch token IDs from Gamma API first

4. **Rate limiting issues**:
   - ❌ Polling too frequently, hitting rate limits
   - ✅ Poll hourly (MarketLag pattern, section 8.2)

5. **Not handling missing data**:
   - ❌ Assuming all fields exist
   - ✅ Use `.get()` with defaults, handle None values

---

## Mind Trigger: When to Think About This

Think about Polymarket API integration when:
- **Fetching market prices**: MarketLag fetches prices hourly
- **Getting market metadata**: Use Gamma API to get token IDs
- **Price polling**: Use CLOB API to get current prices
- **Error handling**: Implement retry logic for API failures
- **Lambda implementation**: Section 8.1 covers Lambda function structure

**In MarketLag project**: Polymarket producer (Lambda) calls Gamma API to get token IDs, then CLOB API to get prices. Prices are sent to Kafka for Flink processing. Understanding API integration is essential for price data ingestion.

---

## Summary

Polymarket API uses two systems: Gamma API (market metadata, token IDs) and CLOB API (price data). MarketLag uses Gamma API to get token IDs, then CLOB API to get prices. MVP uses public endpoints (no authentication). Implement retry logic for rate limiting. Understanding Polymarket API integration is essential for price data ingestion.

