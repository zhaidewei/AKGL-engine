# Flink SQL Time Attributes

**Learning Point**: 3.6 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 1.3 (Table API/SQL), 1.4 (Time Concepts), 1.5 (Watermarks)
**Version**: Flink 2.2.0

---

## Definition (Engineering Language)

**Time Attribute**: A special column in a Flink table that represents time (event time or processing time). Required for windowing and watermark generation.

**Event Time Attribute**: A time column declared with WATERMARK that represents when events actually occurred. Used for event-time windowing.

**Processing Time Attribute**: A time column that represents when events are processed (system clock). Used for processing-time windowing.

**Time Attribute Declaration**: Declaring time attributes in CREATE TABLE statements using WATERMARK or AS PROCTIME().

**Time Attribute Propagation**: How time attributes flow through SQL queries, enabling windowing in downstream queries.

---

## Plain Language Explanation

Think of time attributes like timestamps in your data:

- **Event Time Attribute** = When it happened: "This event occurred at 14:30:00"
- **Processing Time Attribute** = When we processed it: "We processed this at 15:00:00"
- **WATERMARK Declaration** = Making it event time: "Use this column as event time"

**Why Needed**: MarketLag uses event time attributes for windowing. All tables with windows need time attributes declared.

---

## Analogy

If you know **SQL timestamps** (which you do), Flink time attributes are similar but special:
- SQL TIMESTAMP column = Flink time attribute (but with special meaning)
- SQL WHERE timestamp > ... = Flink windowing (but automatic)

Key difference: Flink time attributes enable automatic windowing and watermark generation.

---

## Relationship to Already Learned Topics

- **1.4 Time Concepts**: Time attributes implement event time and processing time
- **1.5 Watermarks**: Event time attributes generate watermarks
- **1.6 Windows**: Windows require time attributes
- **2.2 Kafka Table Connector**: Time attributes declared in CREATE TABLE

---

## Pseudocode (From Source Code)

Based on Flink 2.2.0 source code:

```sql
-- Event time attribute (simplified)
CREATE TABLE events (
    time_col TIMESTAMP(3),
    WATERMARK FOR time_col AS time_col - INTERVAL '5' MINUTE
)
-- Parses to: EventTimeAttribute with watermark delay

-- Processing time attribute (simplified)
CREATE TABLE events (
    proc_time AS PROCTIME()
)
-- Parses to: ProcessingTimeAttribute
```

---

## Source Code References

**Local Path**: `generation_pipeline/step0_context/source_codes/flink/flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/TimeAttribute.java`

**GitHub URL**: https://github.com/apache/flink/blob/release-2.2/flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/TimeAttribute.java

---

## Event Time Attribute Declaration in CREATE TABLE

### Basic Declaration

```sql
CREATE TABLE events (
    id BIGINT,
    event_time TIMESTAMP(3),
    value DOUBLE,
    WATERMARK FOR event_time AS event_time - INTERVAL '5' MINUTE
) WITH (...);
```

**Key Points**:
- **TIMESTAMP(3)**: Millisecond precision (required for watermarks)
- **WATERMARK FOR**: Declares event time attribute
- **INTERVAL '5' MINUTE**: Watermark delay (section 1.5)

**MarketLag Project**: Uses this pattern for all event-time tables.

### MarketLag Example

```sql
CREATE TABLE rss_events (
    title STRING,
    published_at TIMESTAMP(3),
    source STRING,
    WATERMARK FOR published_at AS published_at - INTERVAL '5' MINUTE
) WITH (
    'connector' = 'kafka',
    -- configuration
);
```

**This is the exact pattern used in MarketLag**.

---

## Processing Time Attribute Declaration

### Basic Declaration

```sql
CREATE TABLE events (
    id BIGINT,
    value DOUBLE,
    proc_time AS PROCTIME()
) WITH (...);
```

**Key Points**:
- **AS PROCTIME()**: Declares processing time attribute
- **No WATERMARK**: Processing time doesn't need watermarks
- **Automatic**: System clock, no extraction needed

**Use Case**: When exact event time doesn't matter, use processing time for simplicity.

---

## Time Attribute Propagation Through Queries

### Propagation Rules

Time attributes propagate through queries:
- **SELECT**: Time attribute in SELECT propagates
- **WHERE**: Time attribute still available after WHERE
- **JOIN**: Time attribute from left table propagates
- **GROUP BY**: Time attribute available for windowing

### Example

```sql
-- Time attribute propagates
SELECT
    market_slug,
    published_at,  -- Event time attribute
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

**Time attribute `published_at` is available for windowing**.

---

## Minimum Viable Code

```java
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;

public class TimeAttributeDemo {
    public static void main(String[] args) throws Exception {
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);

        // Create table with event time attribute
        tableEnv.executeSql(
            "CREATE TABLE events (" +
            "  id BIGINT," +
            "  event_time TIMESTAMP(3)," +
            "  value DOUBLE," +
            "  WATERMARK FOR event_time AS event_time - INTERVAL '5' MINUTE" +
            ") WITH (" +
            "  'connector' = 'kafka'," +
            "  'topic' = 'events'," +
            "  'format' = 'json'" +
            ")"
        );

        // Use time attribute for windowing
        tableEnv.executeSql(
            "SELECT " +
            "  TUMBLE_START(event_time, INTERVAL '1' HOUR) as window_start," +
            "  COUNT(*) as count " +
            "FROM events " +
            "GROUP BY TUMBLE(event_time, INTERVAL '1' HOUR)"
        );

        env.execute("Time Attribute Demo");
    }
}
```

---

## Common Mistakes

1. **Missing TIMESTAMP(3)**:
   - ❌ Using TIMESTAMP instead of TIMESTAMP(3)
   - ✅ Use TIMESTAMP(3) for millisecond precision (required for watermarks)

2. **Missing WATERMARK**:
   - ❌ Event time column without WATERMARK declaration
   - ✅ Always declare: `WATERMARK FOR time_col AS ...`

3. **Wrong time column**:
   - ❌ Using wrong column for time attribute
   - ✅ Use actual event time column (published_at, event_time, etc.)

4. **Time attribute not propagating**:
   - ❌ Time attribute lost in complex query
   - ✅ Understand propagation rules, test with simple queries first

5. **Processing time when event time needed**:
   - ❌ Using PROCTIME() for event-time windows
   - ✅ Use event time attribute for event-time windows

---

## Mind Trigger: When to Think About This

Think about time attributes when:
- **Creating tables**: All event-time tables need time attribute declaration
- **Windowing**: Windows require time attributes (section 1.6, 3.1)
- **Watermark configuration**: Event time attributes generate watermarks (section 1.5)
- **Query design**: Understanding propagation helps design queries
- **MarketLag tables**: All MarketLag tables use event time attributes

**In MarketLag project**: All tables (rss_events, polymarket_price_hourly) declare event time attributes with WATERMARK. Time attributes enable windowing in Jobs 1 and 3. Understanding time attributes is essential for event-time processing.

---

## Summary

Flink SQL time attributes represent time in tables. Event time attributes are declared with WATERMARK and TIMESTAMP(3). Processing time attributes use PROCTIME(). Time attributes propagate through queries, enabling windowing. MarketLag uses event time attributes for all tables. Understanding time attributes is essential for event-time windowing and watermark generation.

