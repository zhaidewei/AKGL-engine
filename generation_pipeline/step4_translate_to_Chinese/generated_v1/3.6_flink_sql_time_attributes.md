# Flink SQL 时间属性

**Learning Point**: 3.6 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 1.3 (Table API/SQL), 1.4 (Time Concepts), 1.5 (Watermarks)
**Version**: Flink 2.2.0

---

## 工程化定义

**Time Attribute**: Flink 表中表示时间（event time 或 processing time）的特殊列。窗口化和 watermark 生成需要它。

**Event Time Attribute**: 使用 WATERMARK 声明的表示事件实际发生时间的时间列。用于 event-time 窗口化。

**Processing Time Attribute**: 表示事件处理时间（系统时钟）的时间列。用于 processing-time 窗口化。

**Time Attribute Declaration**: 在 CREATE TABLE 语句中使用 WATERMARK 或 AS PROCTIME() 声明 time attributes。

**Time Attribute Propagation**: time attributes 如何流经 SQL 查询，在下游查询中启用窗口化。

---

## 通俗解释

将 time attributes 想象成数据中的时间戳：

- **Event Time Attribute** = 何时发生："此事件发生在 14:30:00"
- **Processing Time Attribute** = 我们何时处理它："我们在 15:00:00 处理了这个"
- **WATERMARK Declaration** = 使其成为 event time："使用此列作为 event time"

**为什么需要**：MarketLag 使用 event time attributes 进行窗口化。所有带窗口的表都需要声明 time attributes。

---

## 类比理解

如果您了解 **SQL timestamps**（您了解），Flink time attributes 类似但特殊：
- SQL TIMESTAMP 列 = Flink time attribute（但具有特殊含义）
- SQL WHERE timestamp > ... = Flink 窗口化（但是自动的）

关键区别：Flink time attributes 启用自动窗口化和 watermark 生成。

---

## 与已学内容的关系

- **1.4 Time Concepts**: Time attributes implement event time and processing time
- **1.5 Watermarks**: Event time attributes generate watermarks
- **1.6 Windows**: Windows require time attributes
- **2.2 Kafka Table Connector**: Time attributes declared in CREATE TABLE

---

## 伪代码（基于源码）

Based on Flink 2.2.0 source code:

```sql
-- Event time attribute (simplified)
CREATE TABLE events (
    time_col TIMESTAMP(3),
    WATERMARK FOR time_col AS time_col - INTERVAL '5' MINUTE
)
-- Parses to: EventTimeAttribute with watermark delay

-- Processing time attribute (simplified)
CREATE TABLE events (
    proc_time AS PROCTIME()
)
-- Parses to: ProcessingTimeAttribute
```

---

## 源码参考

**Local Path**: `generation_pipeline/step0_context/source_codes/flink/flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/TimeAttribute.java`

**GitHub URL**: https://github.com/apache/flink/blob/release-2.2/flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/TimeAttribute.java

---

## CREATE TABLE 中事件时间属性声明

### Basic Declaration

```sql
CREATE TABLE events (
    id BIGINT,
    event_time TIMESTAMP(3),
    value DOUBLE,
    WATERMARK FOR event_time AS event_time - INTERVAL '5' MINUTE
) WITH (...);
```

**Key Points**:
- **TIMESTAMP(3)**: Millisecond precision (required for watermarks)
- **WATERMARK FOR**: Declares event time attribute
- **INTERVAL '5' MINUTE**: Watermark delay (section 1.5)

**MarketLag Project**: Uses this pattern for all event-time tables.

### MarketLag Example

```sql
CREATE TABLE rss_events (
    title STRING,
    published_at TIMESTAMP(3),
    source STRING,
    WATERMARK FOR published_at AS published_at - INTERVAL '5' MINUTE
) WITH (
    'connector' = 'kafka',
    -- configuration
);
```

**This is the exact pattern used in MarketLag**.

---

## 处理时间属性声明

### Basic Declaration

```sql
CREATE TABLE events (
    id BIGINT,
    value DOUBLE,
    proc_time AS PROCTIME()
) WITH (...);
```

**Key Points**:
- **AS PROCTIME()**: Declares processing time attribute
- **No WATERMARK**: Processing time doesn't need watermarks
- **Automatic**: System clock, no extraction needed

**Use Case**: When exact event time doesn't matter, use processing time for simplicity.

---

## 时间属性在查询中的传播

### Propagation Rules

Time attributes propagate through queries:
- **SELECT**: Time attribute in SELECT propagates
- **WHERE**: Time attribute still available after WHERE
- **JOIN**: Time attribute from left table propagates
- **GROUP BY**: Time attribute available for windowing

### Example

```sql
-- Time attribute propagates
SELECT
    market_slug,
    published_at,  -- Event time attribute
    TUMBLE_START(published_at, INTERVAL '1' HOUR) as window_start
FROM rss_events
GROUP BY market_slug, TUMBLE(published_at, INTERVAL '1' HOUR);
```

**Time attribute `published_at` is available for windowing**.

---

## 最小可用代码

```java
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;

public class TimeAttributeDemo {
    public static void main(String[] args) throws Exception {
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);

        // Create table with event time attribute
        tableEnv.executeSql(
            "CREATE TABLE events (" +
            "  id BIGINT," +
            "  event_time TIMESTAMP(3)," +
            "  value DOUBLE," +
            "  WATERMARK FOR event_time AS event_time - INTERVAL '5' MINUTE" +
            ") WITH (" +
            "  'connector' = 'kafka'," +
            "  'topic' = 'events'," +
            "  'format' = 'json'" +
            ")"
        );

        // Use time attribute for windowing
        tableEnv.executeSql(
            "SELECT " +
            "  TUMBLE_START(event_time, INTERVAL '1' HOUR) as window_start," +
            "  COUNT(*) as count " +
            "FROM events " +
            "GROUP BY TUMBLE(event_time, INTERVAL '1' HOUR)"
        );

        env.execute("Time Attribute Demo");
    }
}
```

---

## 常见错误

1. **缺少 TIMESTAMP(3)**：
   - ❌ 使用 TIMESTAMP 而不是 TIMESTAMP(3)
   - ✅ 使用 TIMESTAMP(3) 以获得毫秒精度（watermarks 需要）

2. **缺少 WATERMARK**：
   - ❌ Event time 列没有 WATERMARK 声明
   - ✅ 始终声明：`WATERMARK FOR time_col AS ...`

3. **错误的时间列**：
   - ❌ 对 time attribute 使用错误的列
   - ✅ 使用实际的 event time 列（published_at、event_time 等）

4. **Time attribute 未传播**：
   - ❌ Time attribute 在复杂查询中丢失
   - ✅ 理解传播规则，先用简单查询测试

5. **需要 event time 时使用 processing time**：
   - ❌ 对 event-time 窗口使用 PROCTIME()
   - ✅ 对 event-time 窗口使用 event time attribute

---

## 触发点：什么时候想到这个概念

在以下情况下考虑 time attributes：
- **创建表**：所有 event-time 表都需要 time attribute 声明
- **窗口化**：窗口需要 time attributes（第 1.6、3.1 节）
- **Watermark 配置**：Event time attributes 生成 watermarks（第 1.5 节）
- **查询设计**：理解传播有助于设计查询
- **MarketLag 表**：所有 MarketLag 表都使用 event time attributes

**在 MarketLag 项目中**：所有表（rss_events、polymarket_price_hourly）都使用 WATERMARK 声明 event time attributes。Time attributes 在 Jobs 1 和 3 中启用窗口化。理解 time attributes 对于 event-time 处理至关重要。

---

## 小结

Flink SQL time attributes 表示表中的时间。Event time attributes 使用 WATERMARK 和 TIMESTAMP(3) 声明。Processing time attributes 使用 PROCTIME()。Time attributes 通过查询传播，启用窗口化。MarketLag 对所有表使用 event time attributes。理解 time attributes 对于 event-time 窗口化和 watermark 生成至关重要。

