# Flink 异步 I/O

**Learning Point**: 14.2 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 1.2 (DataStream API), understanding of asynchronous programming
**Version**: Flink 2.2.0

---

## Definition (Engineering Language)

**Flink Async I/O**: 用于通过外部查找（API、数据库）丰富数据流的异步 I/O 操作。通过不阻塞 I/O 来提高吞吐量。

**AsyncFunction**: 实现异步查找的接口。返回 Future 用于非阻塞 I/O。

**Async I/O Configuration**: 配置容量（并发请求）、超时和重试设置。

**Why Not Used in MVP**: MarketLag 在 Flink 中不需要外部 API 查找（数据丰富发生在 Lambda producers 中）。如果需要使用外部 API 丰富数据，Async I/O 很有用。

---

## Plain Language Explanation

将 Async I/O 视为在烹饪时点餐：

- **Synchronous I/O** = 等待订单："点餐，等待，然后烹饪"
- **Async I/O** = 烹饪时点餐："在烹饪时点餐，不等待"

**为什么未使用**: MarketLag 在 Lambda（Kafka 之前）中丰富数据，而不是在 Flink 中，因此不需要 Async I/O。

---

## Analogy

如果您了解 **异步编程**（您了解），Flink Async I/O 类似：
- Async/await = AsyncFunction（两者都启用非阻塞 I/O）
- Promise/Future = Future return（两者都表示异步结果）
- Non-blocking = Async I/O（两者都不阻塞线程）

关键区别：Flink Async I/O 与 Flink 的流处理模型集成。

---

## Relationship to Already Learned Topics

- **1.2 DataStream API**：Async I/O 使用 DataStream API
- **7.3 Computation Placement**：MarketLag 在 Lambda 中丰富数据，而不是在 Flink 中
- **Asynchronous Programming**：您已经了解异步 - Flink 扩展了它

---

## AsyncFunction for External Lookups

### Basic AsyncFunction

**Purpose**: Enrich stream records with data from external APIs or databases.

**Interface**:
```java
public abstract class AsyncFunction<IN, OUT> implements Function {
    public abstract void asyncInvoke(IN input, ResultFuture<OUT> resultFuture) throws Exception;
}
```

**Example**: Enriching events with external API data.

```java
public class EnrichmentAsyncFunction extends AsyncFunction<Event, EnrichedEvent> {
    private transient AsyncHttpClient httpClient;

    @Override
    public void open(Configuration config) {
        httpClient = new AsyncHttpClient();
    }

    @Override
    public void asyncInvoke(Event event, ResultFuture<EnrichedEvent> resultFuture) {
        // Async HTTP request
        httpClient.prepareGet("https://api.example.com/enrich/" + event.getId())
            .execute(new AsyncCompletionHandler<Response>() {
                @Override
                public Response onCompleted(Response response) {
                    // Parse response
                    EnrichmentData data = parseResponse(response);
                    EnrichedEvent enriched = new EnrichedEvent(event, data);
                    resultFuture.complete(Collections.singleton(enriched));
                    return response;
                }

                @Override
                public void onThrowable(Throwable t) {
                    resultFuture.completeExceptionally(t);
                }
            });
    }
}
```

**MarketLag**: Could use Async I/O if needing to enrich data in Flink (not needed in MVP).

---

## Async I/O Configuration: Capacity, Timeout

### Configuration

**Capacity**: Maximum number of concurrent async requests.

**Timeout**: Maximum time to wait for async request.

**Retry**: Retry policy for failed requests.

```java
AsyncDataStream.orderedWait(
    stream,
    new EnrichmentAsyncFunction(),
    1000,  // Timeout: 1 second
    TimeUnit.MILLISECONDS,
    100    // Capacity: 100 concurrent requests
);
```

**MarketLag**: Would configure capacity and timeout if using Async I/O.

---

## Why Not Used in MVP: Data Enrichment in Lambda

### MarketLag Architecture

**Data Enrichment**: Happens in Lambda producers (before Kafka), not in Flink.

**Why**:
- **Simpler**: Lambda handles API calls, Flink processes pre-enriched data
- **Separation**: Lambda = data preparation, Flink = processing
- **No Need**: Flink doesn't need to call external APIs

**MarketLag**: Enriches data in Lambda (RSS processing, Polymarket API), sends enriched data to Kafka.

### When to Use Async I/O

**Use Cases**:
- Enriching data in Flink (not in producer)
- Real-time lookups during processing
- External API calls from Flink

**MarketLag**: Not needed (data already enriched in Lambda).

---

## Minimum Viable Code

```java
import org.apache.flink.streaming.api.datastream.AsyncDataStream;
import org.apache.flink.streaming.api.functions.async.AsyncFunction;
import org.apache.flink.streaming.api.functions.async.ResultFuture;

public class AsyncIODemo {
    public static class EnrichmentAsyncFunction extends AsyncFunction<Event, EnrichedEvent> {
        @Override
        public void asyncInvoke(Event event, ResultFuture<EnrichedEvent> resultFuture) {
            // Async lookup
            CompletableFuture.supplyAsync(() -> {
                // Call external API
                EnrichmentData data = callExternalAPI(event.getId());
                return new EnrichedEvent(event, data);
            }).thenAccept(enriched -> {
                resultFuture.complete(Collections.singleton(enriched));
            }).exceptionally(throwable -> {
                resultFuture.completeExceptionally(throwable);
                return null;
            });
        }
    }

    public static void main(String[] args) throws Exception {
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();

        DataStream<Event> stream = ...;

        // Apply Async I/O
        DataStream<EnrichedEvent> enriched = AsyncDataStream.orderedWait(
            stream,
            new EnrichmentAsyncFunction(),
            1000,  // Timeout
            TimeUnit.MILLISECONDS,
            100    // Capacity
        );

        env.execute("Async I/O Demo");
    }
}
```

---

## Common Mistakes

1. **在不需要时使用 Async I/O**:
   - ❌ 对简单查找使用 Async I/O（过度设计）
   - ✅ 仅在 Flink 中丰富数据时使用 Async I/O

2. **不配置容量**:
   - ❌ 太多并发请求（压垮外部 API）
   - ✅ 根据 API 限制设置适当的容量

3. **不设置超时**:
   - ❌ 请求无限期挂起
   - ✅ 设置超时以防止挂起

4. **不处理错误**:
   - ❌ 未处理异步失败
   - ✅ 在 asyncInvoke 中处理错误

5. **不考虑顺序**:
   - ❌ 在顺序重要时使用 unorderedWait
   - ✅ 如果顺序重要，使用 orderedWait

---

## Mind Trigger: When to Think About This

在以下情况下考虑 Flink Async I/O：
- **在 Flink 中丰富数据**: 需要从 Flink 调用外部 API
- **实时查找**: 需要在处理期间查找数据
- **MVP 中未使用**: MarketLag 在 Lambda 中丰富数据，而不是 Flink
- **替代方法**: 如果将丰富移到 Flink，考虑 Async I/O
- **性能**: Async I/O 提高 I/O 绑定操作的吞吐量

**在 MarketLag 项目中**: MVP 中未使用 Async I/O（数据丰富发生在 Lambda 中）。理解 Async I/O 有助于评估是否应将丰富移到 Flink。Async I/O 是可选的，但如果需要使用外部 API 丰富数据，它很有用。

---

## Summary

Flink Async I/O 支持通过外部查找丰富数据流的异步 I/O 操作。使用 AsyncFunction 实现异步查找。配置容量和超时。MarketLag 在 MVP 中不使用 Async I/O（数据丰富发生在 Lambda 中）。如果需要在 Flink 中使用外部 API 丰富数据，Async I/O 很有用。理解 Async I/O 有助于评估丰富策略。

