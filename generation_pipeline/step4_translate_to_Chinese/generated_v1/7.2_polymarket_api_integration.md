# Polymarket API 集成

**Learning Point**: 7.2 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 理解 REST APIs、JSON 解析、Python 基础知识
**Version**: Polymarket API (current)

---

## Definition (Engineering Language)

**Polymarket API Architecture**: Polymarket 使用两个独立的 API 系统：用于市场元数据的 Gamma API 和用于价格数据的 CLOB API。

**Gamma API**: 用于检索市场元数据的 REST API，包括市场信息、token IDs（YES/NO tokens）和市场结构。

**CLOB API**: 用于检索特定 tokens 价格数据的 REST API。使用带有 token IDs 的 POST 请求来获取当前价格。

**API Authentication**: MVP 使用公共端点（不需要身份验证）。生产环境可能需要 API keys。

**Rate Limiting**: API 速率限制以防止滥用。必须实现带指数退避的重试逻辑。

---

## Plain Language Explanation

将 Polymarket API 想象成两步查找：

- **Gamma API** = 目录："存在哪些市场？token IDs 是什么？"
- **CLOB API** = 价格查找："这些 tokens 的当前价格是多少？"

**Why Two APIs**: 市场元数据（结构）变化不频繁，价格变化频繁。分离它们可以优化性能。

---

## Analogy

如果您了解 **stock market APIs**（您了解），Polymarket API 是类似的：
- Market data API = Gamma API（两者都提供市场结构）
- Price API = CLOB API（两者都提供当前价格）

关键区别：Polymarket 使用预测市场 tokens（YES/NO）而不是股票。

---

## Relationship to Already Learned Topics

- **8.1 AWS Lambda**: Polymarket API 调用在 Lambda 函数中运行
- **8.2 EventBridge**: 每小时价格轮询的定时触发器
- **7.4 Price Delta**: 价格数据用于 delta 计算
- **REST APIs**: 您已经了解 REST APIs - Polymarket 使用标准 REST

---

## Polymarket API Architecture: Gamma API vs CLOB API

### Gamma API (Market Metadata)

**Purpose**: 获取市场结构和 token IDs。

**Use Case**: 一次性或不频繁的调用来获取市场信息。

**MarketLag**: 使用 Gamma API 获取市场的 token IDs。

### CLOB API (Price Data)

**Purpose**: 获取 tokens 的当前价格。

**Use Case**: 频繁调用来获取最新价格。

**MarketLag**: 每小时使用 CLOB API 获取当前价格。

---

## Gamma API: `GET https://gamma-api.polymarket.com/markets/slug/{slug}`

### Endpoint

**URL**: `GET https://gamma-api.polymarket.com/markets/slug/{slug}`

**Example**: `GET https://gamma-api.polymarket.com/markets/slug/fed-hike-january`

**Method**: GET

**Authentication**: 无（MVP 的公共端点）

**Response**: 带有市场元数据的 JSON

### Response Structure

```json
{
  "slug": "fed-hike-january",
  "question": "Will the Fed raise rates in January?",
  "clobTokenIds": {
    "YES": "0x1234...",
    "NO": "0x5678..."
  },
  "closeTime": "2024-01-31T23:59:59Z"
}
```

### MarketLag Usage

```python
import requests

def get_market_tokens(market_slug):
    """
    Get token IDs for a market.

    Args:
        market_slug: Market slug (e.g., "fed-hike-january")

    Returns:
        dict: Token IDs {"YES": "0x...", "NO": "0x..."}
    """
    url = f"https://gamma-api.polymarket.com/markets/slug/{market_slug}"
    response = requests.get(url)
    data = response.json()

    return data.get('clobTokenIds', {})

# Usage
tokens = get_market_tokens("fed-hike-january")
yes_token = tokens.get("YES")
no_token = tokens.get("NO")
```

**MarketLag**: 调用 Gamma API 获取 token IDs，然后在 CLOB API 中使用它们。

---

## CLOB API: `POST https://clob.polymarket.com/prices`

### Endpoint

**URL**: `POST https://clob.polymarket.com/prices`

**Method**: POST

**Request Body**: 带有 token IDs 的 JSON
```json
{
  "token_ids": ["0x1234...", "0x5678..."]
}
```

**Authentication**: 无（MVP 的公共端点）

**Response**: 带有价格的 JSON
```json
{
  "0x1234...": {
    "price": 0.65,
    "side": "BUY"
  },
  "0x5678...": {
    "price": 0.35,
    "side": "BUY"
  }
}
```

### MarketLag Usage

```python
def get_prices(token_ids):
    """
    Get prices for tokens.

    Args:
        token_ids: List of token IDs

    Returns:
        dict: Prices {token_id: price}
    """
    url = "https://clob.polymarket.com/prices"
    payload = {"token_ids": token_ids}

    response = requests.post(url, json=payload)
    data = response.json()

    prices = {}
    for token_id, price_data in data.items():
        prices[token_id] = price_data.get('price', 0.0)

    return prices

# Usage
token_ids = [yes_token, no_token]
prices = get_prices(token_ids)
yes_price = prices.get(yes_token, 0.0)
no_price = prices.get(no_token, 0.0)
```

**MarketLag**: 每小时调用 CLOB API 获取 YES/NO tokens 的当前价格。

---

## API Authentication: Public Endpoints (MVP)

### MVP: No Authentication

**Current**: Polymarket API 公共端点对于 MVP 不需要身份验证。

**Limitations**: 可能有速率限制，将来可能会改变。

**MarketLag**: MVP 使用公共端点。

### Production: API Keys (Future)

**Future**: 可能需要 API keys 以获得更高的速率限制或附加功能。

**Implementation**: 将 API key 添加到请求头：
```python
headers = {
    'Authorization': f'Bearer {api_key}'
}
response = requests.get(url, headers=headers)
```

---

## Rate Limiting and Error Handling

### Rate Limiting

**Issue**: API 可能会限制请求速率。

**Solution**: 实现带指数退避的重试：

```python
import time
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

def get_with_retry(url, max_retries=3):
    """
    Get with exponential backoff retry.
    """
    session = requests.Session()
    retry_strategy = Retry(
        total=max_retries,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504]
    )
    adapter = HTTPAdapter(max_retries=retry_strategy)
    session.mount("http://", adapter)
    session.mount("https://", adapter)

    return session.get(url)

# Usage
response = get_with_retry("https://gamma-api.polymarket.com/markets/slug/fed-hike-january")
```

**MarketLag**: 在 Lambda 函数中实现重试逻辑（第 8.1 节）。

---

## Minimum Viable Code

```python
import requests
from datetime import datetime
import pytz

def fetch_polymarket_price(market_slug):
    """
    Fetch Polymarket price for a market.

    Args:
        market_slug: Market slug (e.g., "fed-hike-january")

    Returns:
        dict: Price data {outcome: price, event_time: timestamp}
    """
    # Step 1: Get token IDs from Gamma API
    gamma_url = f"https://gamma-api.polymarket.com/markets/slug/{market_slug}"
    gamma_response = requests.get(gamma_url)
    gamma_data = gamma_response.json()

    token_ids = gamma_data.get('clobTokenIds', {})
    yes_token = token_ids.get('YES')
    no_token = token_ids.get('NO')

    if not yes_token or not no_token:
        return None

    # Step 2: Get prices from CLOB API
    clob_url = "https://clob.polymarket.com/prices"
    clob_payload = {"token_ids": [yes_token, no_token]}
    clob_response = requests.post(clob_url, json=clob_payload)
    clob_data = clob_response.json()

    # Extract prices
    yes_price = clob_data.get(yes_token, {}).get('price', 0.0)
    no_price = clob_data.get(no_token, {}).get('price', 0.0)

    # Return price data (use YES price as market price)
    return {
        'market_slug': market_slug,
        'outcome': 'YES',
        'price': yes_price,
        'event_time': datetime.now(pytz.UTC).isoformat()
    }

# Usage
price_data = fetch_polymarket_price("fed-hike-january")
```

---

## Common Mistakes

1. **Not handling API errors**:
   - ❌ 没有错误处理，API 错误时作业失败
   - ✅ 实现重试逻辑、错误处理（第 9.1 节）

2. **Wrong API endpoint**:
   - ❌ 使用 Gamma API 获取价格（错误的 API）
   - ✅ 使用 Gamma API 获取元数据，使用 CLOB API 获取价格

3. **Not extracting token IDs**:
   - ❌ 硬编码 token IDs（它们可能会改变）
   - ✅ 始终先从 Gamma API 获取 token IDs

4. **Rate limiting issues**:
   - ❌ 轮询过于频繁，达到速率限制
   - ✅ 每小时轮询一次（MarketLag 模式，第 8.2 节）

5. **Not handling missing data**:
   - ❌ 假设所有字段都存在
   - ✅ 使用带默认值的 `.get()`，处理 None 值

---

## Mind Trigger: When to Think About This

在以下情况下考虑 Polymarket API 集成：
- **获取市场价格**: MarketLag 每小时获取价格
- **获取市场元数据**: 使用 Gamma API 获取 token IDs
- **价格轮询**: 使用 CLOB API 获取当前价格
- **错误处理**: 为 API 失败实现重试逻辑
- **Lambda 实现**: 第 8.1 节涵盖 Lambda 函数结构

**在 MarketLag 项目中**: Polymarket producer（Lambda）调用 Gamma API 获取 token IDs，然后调用 CLOB API 获取价格。价格被发送到 Kafka 供 Flink 处理。理解 API 集成对于价格数据获取至关重要。

---

## Summary

Polymarket API 使用两个系统：Gamma API（市场元数据、token IDs）和 CLOB API（价格数据）。MarketLag 使用 Gamma API 获取 token IDs，然后使用 CLOB API 获取价格。MVP 使用公共端点（不需要身份验证）。实现重试逻辑以处理速率限制。理解 Polymarket API 集成对于价格数据获取至关重要。
