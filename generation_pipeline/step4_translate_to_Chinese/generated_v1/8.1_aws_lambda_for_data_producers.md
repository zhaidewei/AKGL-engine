# AWS Lambda 用于数据生产者

**Learning Point**: 8.1 from knowledge_and_skills_needed_v2.md
**Prerequisites**: AWS Lambda 基础知识、Python 基础知识、Kafka producer 知识
**Version**: Python 3.9+, AWS Lambda

---

## 工程化定义

**AWS Lambda for Data Producers**: 使用 AWS Lambda 函数从外部源（RSS feeds、Polymarket API）获取数据并将消息生成到 Kafka topics。

**Lambda Function Structure**: Handler 函数、依赖项、环境变量和配置。

**Lambda Layers**: 与函数代码分开打包的共享代码和依赖项。用于 kafka-python、confluent-kafka 库。

**Lambda Environment Variables**: 传递给 Lambda 函数的配置值（Kafka 端点、API keys 等）。

**Lambda Configuration**: 超时（MarketLag 为 5 分钟）、内存（MarketLag 为 256MB）和其他设置。

---

## 通俗解释

将 Lambda 想象成一个定时工作器：

- **Lambda Function** = 工作器："每 15 分钟获取一次 RSS feeds"
- **Handler** = 工作器的任务："工作器被触发时执行的操作"
- **Layers** = 工具箱："工作器使用的共享工具（库）"
- **Environment Variables** = 指令："Kafka 端点、API keys"

**Why Needed**: MarketLag 使用 Lambda 函数获取 RSS feeds 和 Polymarket 价格，然后发送到 Kafka。

---

## 类比理解

如果您了解 **cron jobs**（您了解），Lambda 是类似的：
- Cron job = Lambda function（两者都按计划运行）
- Cron schedule = EventBridge trigger（两者都在间隔时触发）
- Cron script = Lambda handler（两者都包含逻辑）

关键区别：Lambda 是无服务器的，自动扩展，无需服务器管理。

---

## 与已学内容的关系

- **8.2 EventBridge**: 按计划触发 Lambda 函数
- **8.3 Lambda-Kafka**: Lambda 写入 Kafka
- **7.1 RSS Processing**: RSS producer 在 Lambda 中运行
- **7.2 Polymarket API**: Polymarket producer 在 Lambda 中运行
- **AWS**: 您已经从经验中了解 AWS Lambda

---

## Lambda 函数结构：Handler 与依赖

### Basic Structure

```python
# lambda_function.py
import json
import boto3

def lambda_handler(event, context):
    """
    Lambda handler function.

    Args:
        event: Event data (from EventBridge, API Gateway, etc.)
        context: Lambda context (runtime information)

    Returns:
        dict: Response
    """
    # Your logic here
    result = process_data()

    return {
        'statusCode': 200,
        'body': json.dumps(result)
    }
```

**MarketLag**: RSS 和 Polymarket producers 使用此结构。

### Handler Function

**Required**: `lambda_handler(event, context)` 是入口点。

**Event**: 包含触发器数据（EventBridge 计划等）

**Context**: 包含运行时信息（函数名称、剩余时间等）

---

## Lambda Layers：共享依赖

### Problem

Kafka 库（kafka-python、confluent-kafka）很大。将它们包含在函数代码中会增加部署包大小。

**Solution**: 对共享依赖项使用 Lambda Layers。

### Creating Layer

```bash
# Create layer directory
mkdir python
pip install kafka-python confluent-kafka -t python/

# Package layer
zip -r kafka-layer.zip python/

# Upload to Lambda (via AWS CLI or console)
aws lambda publish-layer-version \
    --layer-name kafka-dependencies \
    --zip-file fileb://kafka-layer.zip \
    --compatible-runtimes python3.9
```

### Using Layer

将 layer 附加到 Lambda 函数（通过控制台或 CLI）：

```python
# In Lambda function, libraries are available
from kafka import KafkaProducer
from confluent_kafka import Producer
```

**MarketLag**: 对 Kafka 依赖项使用 Lambda layers。

---

## Lambda 环境变量与配置

### Environment Variables

在 Lambda 配置中设置：

```python
import os

# Access environment variables
kafka_endpoint = os.environ['KAFKA_ENDPOINT']
api_key = os.environ['API_KEY']
api_secret = os.environ['API_SECRET']
```

**MarketLag**: 对环境变量使用：
- Confluent Cloud Kafka 端点
- API keys 和 secrets
- DynamoDB 表名

### Configuration

**Timeout**: MarketLag 为 5 分钟（300 秒）
- RSS producer: 可能需要时间来获取和处理 feeds
- Polymarket producer: 可能需要时间进行 API 调用

**Memory**: MarketLag 为 256MB
- 足够用于 RSS 解析和 Kafka 发布
- 如果需要可以增加

**MarketLag Configuration**:
- Timeout: 300 秒（5 分钟）
- Memory: 256 MB
- Runtime: Python 3.9+

---

## Lambda 超时与内存配置：超时 5 分钟，内存 256MB

### Timeout Configuration

**Setting**: 300 秒（5 分钟）

**Why**:
- RSS 获取和解析可能需要时间
- Polymarket API 调用可能有延迟
- Kafka 发布可能需要时间

**MarketLag**: 两个 producers 都使用 5 分钟超时。

### Memory Configuration

**Setting**: 256 MB

**Why**:
- RSS 解析是轻量级的
- Kafka 发布是轻量级的
- 256 MB 足够

**MarketLag**: 两个 producers 都使用 256 MB。

### Configuration Example

```python
# Lambda configuration (via AWS Console or CLI)
# Timeout: 300 seconds
# Memory: 256 MB
# Runtime: Python 3.9
# Handler: lambda_function.lambda_handler
```

---

## 最小可用代码

```python
# lambda_function.py
import os
import json
from datetime import datetime
import pytz
from kafka import KafkaProducer

# Environment variables
KAFKA_ENDPOINT = os.environ['KAFKA_ENDPOINT']
KAFKA_API_KEY = os.environ['KAFKA_API_KEY']
KAFKA_API_SECRET = os.environ['KAFKA_API_SECRET']
TOPIC = os.environ['KAFKA_TOPIC']

def lambda_handler(event, context):
    """
    Lambda handler for data producer.
    """
    try:
        # Create Kafka producer
        producer = KafkaProducer(
            bootstrap_servers=KAFKA_ENDPOINT,
            security_protocol='SASL_SSL',
            sasl_mechanism='PLAIN',
            sasl_plain_username=KAFKA_API_KEY,
            sasl_plain_password=KAFKA_API_SECRET,
            value_serializer=lambda v: json.dumps(v).encode('utf-8')
        )

        # Fetch data (RSS or Polymarket)
        data = fetch_data()  # Your data fetching logic

        # Send to Kafka
        for item in data:
            producer.send(TOPIC, value=item)

        producer.flush()
        producer.close()

        return {
            'statusCode': 200,
            'body': json.dumps({'message': 'Success', 'count': len(data)})
        }
    except Exception as e:
        print(f"Error: {e}")
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }

def fetch_data():
    """
    Fetch data from source (RSS or Polymarket).
    """
    # Your data fetching logic
    return []
```

---

## 常见错误

1. **Timeout too short**:
   - ❌ 30 秒超时（在慢速 API 调用时可能超时）
   - ✅ MarketLag 使用 5 分钟（300 秒）

2. **Not using layers**:
   - ❌ 在函数代码中包含大型库（部署缓慢）
   - ✅ 对共享依赖项使用 Lambda layers

3. **Not handling errors**:
   - ❌ 没有错误处理，Lambda 静默失败
   - ✅ 实现 try-catch，返回错误状态

4. **Not closing Kafka producer**:
   - ❌ Producer 未关闭，连接泄漏
   - ✅ 始终调用 `producer.close()` 或使用上下文管理器

5. **Hardcoding configuration**:
   - ❌ 硬编码 Kafka 端点、API keys
   - ✅ 对配置使用环境变量

---

## 触发点：什么时候想到这个概念

在以下情况下考虑 AWS Lambda for data producers：
- **实现 data producers**: MarketLag 对 RSS 和 Polymarket producers 使用 Lambda
- **调度任务**: 第 8.2 节涵盖 EventBridge 调度
- **Kafka 集成**: 第 8.3 节涵盖 Lambda-Kafka 集成
- **错误处理**: 第 9.1 节涵盖错误处理模式
- **配置**: 设置超时、内存、环境变量

**在 MarketLag 项目中**: RSS 和 Polymarket producers 作为 Lambda 函数运行。使用 5 分钟超时、256MB 内存、Lambda layers 用于依赖项。理解 Lambda 对于 data producer 实现至关重要。

---

## 小结

AWS Lambda 函数在 MarketLag 中用于 data producers。Lambda 结构包括 handler 函数、依赖项（通过 layers）、环境变量和配置（超时、内存）。MarketLag 使用 5 分钟超时和 256MB 内存。Lambda layers 用于共享依赖项（Kafka 库）。理解 Lambda 对于 data producer 实现至关重要。
