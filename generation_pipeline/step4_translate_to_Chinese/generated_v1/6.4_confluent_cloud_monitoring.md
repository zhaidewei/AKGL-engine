# Confluent Cloud 监控

**Learning Point**: 6.4 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 6.3 (Deploying Flink Jobs), understanding of monitoring concepts
**Version**: Flink 2.2.0

---

## 工程化定义

**Flink Job Metrics**: 来自 Flink 作业的内置指标，包括吞吐量（记录/秒）、延迟（端到端延迟）、检查点成功率和状态大小。

**Kafka Metrics**: 来自 Kafka 的指标，包括 consumer lag（落后记录数）、吞吐量（消息/秒）和分区分布。

**Alerting Configuration**: 为关键条件（如检查点失败、高 consumer lag 或作业失败）设置自动警报。

**Monitoring Dashboard**: Confluent Cloud 中显示指标、日志和作业状态的 UI 仪表板。

---

## 通俗解释

将监控想象成汽车仪表板：

- **Metrics** = 仪表板仪表："我们处理多快？落后多少记录？"
- **Alerts** = 警告灯："检查点失败！Consumer lag 高！"
- **Dashboard** = 所有仪表在一起："一次看到所有内容"

**为什么需要**：MarketLag 需要监控作业健康状况和性能以确保可靠运行。

---

## 类比理解

如果您了解 **AWS CloudWatch**（您了解），Confluent Cloud 监控类似：
- CloudWatch metrics = Confluent Cloud metrics（两者都跟踪系统健康状况）
- CloudWatch alarms = Confluent Cloud alerts（两者都在出现问题时通知）
- CloudWatch dashboards = Confluent Cloud dashboards（两者都可视化指标）

关键区别：Confluent Cloud 监控专门针对 Kafka 和 Flink。

---

## 与已学内容的关系

- **6.3 Deploying Flink Jobs**: Monitoring jobs after deployment
- **1.10 Checkpoints**: Monitoring checkpoint success rate
- **11.1 Flink Metrics**: Detailed Flink metrics (covered in section 11.1)
- **Monitoring**: You already know monitoring from AWS experience

---

## Flink 作业指标：吞吐、延迟与 Checkpoint 成功率

### Throughput

**定义**：每秒处理的记录数。

**为什么重要**：指示作业性能。低吞吐量可能表示背压或资源约束。

**监控**：在 Confluent Cloud UI 仪表板中跟踪。

**MarketLag**: 监控所有三个作业的吞吐量。

### Latency

**定义**：从事件摄取到输出的端到端延迟。

**为什么重要**：低延迟对实时系统至关重要。

**监控**：跟踪 p50、p95、p99 延迟。

**MarketLag**: 监控延迟以确保 lag 检测及时。

### Checkpoint Success Rate

**定义**：成功检查点的百分比。

**为什么重要**：低成功率表示存在问题（背压、状态太大等）。

**监控**：在检查点成功率 < 95% 时发出警报。

**MarketLag**: 监控检查点成功率（目标：>95%）。

---

## Kafka Metrics: Consumer Lag, Throughput

### Consumer Lag

**Definition**: Number of unprocessed records in Kafka partitions.

**Why Important**: High lag indicates Flink is falling behind, may need scaling.

**Monitoring**: Track consumer lag per partition.

**MarketLag**: Monitor consumer lag for rss.events and polymarket.price_hourly topics.

### Kafka Throughput

**Definition**: Messages produced/consumed per second.

**Why Important**: Ensures Kafka is handling load correctly.

**Monitoring**: Track producer and consumer throughput.

---

## 告警配置：创建与设置告警

### Checkpoint Failure Alerts

**Condition**: Checkpoint success rate < 95% or checkpoint failures

**Action**: Send email/Slack notification

**MarketLag**: Critical alert - checkpoints are essential for fault tolerance.

### High Consumer Lag Alerts

**Condition**: Consumer lag > threshold (e.g., 1000 records)

**Action**: Send notification, may need to scale up

**MarketLag**: Alert if lag > 1000 records for any partition.

### Job Failure Alerts

**Condition**: Flink job status = FAILED

**Action**: Immediate notification

**MarketLag**: Critical alert - job failures stop lag detection.

---

## 最小可用代码

```bash
# Confluent Cloud UI: Configure alerts
# 1. Navigate to Flink job
# 2. Click "Alerts" tab
# 3. Create alert:
#    - Name: "Checkpoint Failure"
#    - Condition: checkpoint_success_rate < 0.95
#    - Action: Send email to team@example.com

# CLI: Create alert (if supported)
confluent flink alert create \
    --job-id "job-123" \
    --name "High Consumer Lag" \
    --condition "consumer_lag > 1000" \
    --action "email:team@example.com"
```

---

## 常见错误

1. **未设置警报**：
   - ❌ 依赖手动检查
   - ✅ 为关键指标（检查点、lag、失败）设置警报

2. **警报疲劳**：
   - ❌ 警报太多，忽略它们
   - ✅ 设置适当的阈值，仅对关键问题发出警报

3. **未监控 consumer lag**：
   - ❌ 不跟踪 lag，错过性能问题
   - ✅ 持续监控 lag，在高 lag 时发出警报

4. **忽略检查点指标**：
   - ❌ 不监控检查点成功率
   - ✅ 监控检查点，立即调查失败

---

## 触发点：什么时候想到这个概念

在以下情况下考虑 Confluent Cloud 监控：
- **部署作业**：部署后设置监控
- **故障排除**：使用指标诊断问题
- **性能调优**：指标有助于识别瓶颈
- **扩展决策**：指标指示何时扩展
- **运营卓越**：监控对生产至关重要

**在 MarketLag 项目中**：监控所有三个作业的吞吐量、延迟、检查点成功率和 consumer lag。为检查点失败、高 lag 和作业失败设置警报。

---

## 小结

Confluent Cloud 监控提供 Flink 作业指标（吞吐量、延迟、检查点成功率）和 Kafka 指标（consumer lag、吞吐量）。警报配置支持为关键条件自动通知。MarketLag 监控所有作业，并为检查点失败、高 lag 和作业失败设置警报。理解监控对于生产操作至关重要。

