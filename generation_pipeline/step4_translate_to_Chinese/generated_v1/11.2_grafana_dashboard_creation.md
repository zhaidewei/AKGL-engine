# Grafana 仪表板创建

**Learning Point**: 11.2 from knowledge_and_skills_needed_v2.md
**Prerequisites**: 11.1 (Flink Metrics), 5.1 (JDBC Connector), SQL knowledge
**Version**: Grafana, PostgreSQL

---

## Definition (Engineering Language)

**Grafana Dashboard Creation**: 在 Grafana 中构建可视化仪表板以监控 MarketLag 系统健康和 lag signals。

**Grafana Data Source Configuration**: 将 Grafana 连接到数据源（PostgreSQL 用于 lag signals，Prometheus 用于 Flink metrics）。

**Panel Types**: 时间序列（折线图）、直方图（分布）、散点图（相关性）、表格（表格数据）。

**SQL Query Example**: 查询 lag_signals_history 表以可视化随时间变化的 lag 检测。

**Dashboard Organization**: 将 panels 组织成逻辑组（lag signals、系统健康、作业 metrics）。

---

## Plain Language Explanation

将 Grafana dashboard 想象成控制室：

- **Dashboard** = 控制室："一次看到所有内容"
- **Panels** = 监视器："每个 panel 显示不同的信息"
- **Data Sources** = 信息源："数据来源（PostgreSQL、Prometheus）"

**为什么需要**：MarketLag 在 Grafana 中可视化 lag signals 和系统健康状态，用于监控和分析。

---

## Analogy

如果您了解 **dashboard tools**（您了解），Grafana 类似：
- Tableau/Power BI = Grafana（都创建 dashboards）
- Data sources = Database connections（都连接到数据）
- Panels = Charts/visualizations（都可视化数据）

关键区别：Grafana 专注于时间序列和运维监控。

---

## Relationship to Already Learned Topics

- **11.1 Flink Metrics**：Metrics 在 Grafana 中可视化
- **5.1 JDBC Connector**：Lag signals 存储在 PostgreSQL 中，由 Grafana 查询
- **SQL**：您已经了解 SQL - Grafana 使用 SQL 查询
- **Monitoring**：您已经了解监控 dashboards

---

## Grafana Data Source Configuration: PostgreSQL, Prometheus

### PostgreSQL Data Source

**Configuration**:
- **Type**: PostgreSQL
- **Host**: Supabase PostgreSQL endpoint
- **Database**: postgres
- **User**: postgres
- **Password**: (from environment)

**MarketLag**：连接到 Supabase PostgreSQL 以查询 lag_signals_history。

### Prometheus Data Source

**Configuration**:
- **Type**: Prometheus
- **URL**: Prometheus endpoint (if Flink metrics exported to Prometheus)

**MarketLag**：可以连接到 Prometheus 获取 Flink 作业 metrics。

---

## Panel Types: Time Series, Histogram, Scatter Plot, Table

### Time Series Panel

**用例**：显示随时间变化的 lag signal 计数。

**示例**：每小时 lag signal 计数。

**MarketLag**：使用 time series 可视化 lag detection 趋势。

### Histogram Panel

**用例**：显示 confidence scores 的分布。

**示例**：Confidence score 分布。

**MarketLag**：可以可视化 confidence score 分布。

### Scatter Plot Panel

**用例**：显示 signal_delta 和 price_delta 之间的相关性。

**示例**：signal_delta vs price_delta 散点图。

**MarketLag**：可以可视化 signal-price 关系。

### Table Panel

**用例**：以表格格式显示最近的 lag signals。

**示例**：最近 100 个 lag signals 及其详细信息。

**MarketLag**：使用 tables 显示最近的 lag detections。

---

## SQL Query Example (Hourly Aggregation)

### Query for Time Series Panel

```sql
SELECT
    date_trunc('hour', detected_at) as hour,
    COUNT(*) as lag_count
FROM lag_signals_history
WHERE lag_flag = true
  AND detected_at >= NOW() - INTERVAL '24 hours'
GROUP BY date_trunc('hour', detected_at)
ORDER BY hour
```

**MarketLag**：使用此查询可视化每小时 lag signal 计数。

### Query for Confidence Distribution

```sql
SELECT
    CASE
        WHEN confidence < 0.5 THEN 'Low'
        WHEN confidence < 0.8 THEN 'Medium'
        ELSE 'High'
    END as confidence_level,
    COUNT(*) as count
FROM lag_signals_history
WHERE lag_flag = true
GROUP BY confidence_level
```

**MarketLag**：可以使用此查询可视化 confidence 分布。

---

## Dashboard Organization and Layout

### Panel Groups

1. **Lag Signals**: Lag detection metrics and trends
2. **System Health**: Flink job metrics, Kafka metrics
3. **Data Quality**: Error rates, DLQ size, validation failures

**MarketLag**：将 dashboard 组织成这些组。

### Layout Example

```
Dashboard: MarketLag Monitoring
├── Lag Signals Section
│   ├── Hourly Lag Count (Time Series)
│   ├── Confidence Distribution (Histogram)
│   └── Recent Lag Signals (Table)
├── System Health Section
│   ├── Flink Job Throughput (Time Series)
│   ├── Checkpoint Success Rate (Time Series)
│   └── Consumer Lag (Time Series)
└── Data Quality Section
    ├── DLQ Size (Time Series)
    └── Validation Errors (Counter)
```

---

## Minimum Viable Code

```sql
-- Grafana SQL Query: Hourly Lag Count
SELECT
    date_trunc('hour', detected_at) as time,
    COUNT(*) as lag_count
FROM lag_signals_history
WHERE lag_flag = true
  AND detected_at >= $__timeFrom()
  AND detected_at <= $__timeTo()
GROUP BY date_trunc('hour', detected_at)
ORDER BY time

-- Grafana SQL Query: Confidence Score Distribution
SELECT
    confidence,
    COUNT(*) as count
FROM lag_signals_history
WHERE lag_flag = true
  AND detected_at >= $__timeFrom()
GROUP BY confidence
ORDER BY confidence
```

---

## Common Mistakes

1. **不使用时间变量**：
   - ❌ 硬编码时间范围
   - ✅ 使用 Grafana 时间变量：`$__timeFrom()`、`$__timeTo()`

2. **查询效率低**：
   - ❌ 查询所有数据而不使用时间过滤器
   - ✅ 始终按时间范围过滤以提高性能

3. **不组织 panels**：
   - ❌ 所有 panels 在一行（难以阅读）
   - ✅ 组织成逻辑组

4. **不设置刷新间隔**：
   - ❌ Dashboard 不自动刷新
   - ✅ 设置适当的刷新间隔（例如，30 秒）

5. **不使用适当的 panel 类型**：
   - ❌ 对时间序列数据使用 table
   - ✅ 对基于时间的数据使用 time series panel

---

## Mind Trigger: When to Think About This

在以下情况下考虑 Grafana dashboard 创建：
- **可视化 lag signals**：MarketLag 在 Grafana 中可视化 lag detection
- **监控系统健康状态**：监控 Flink 作业、Kafka、数据质量
- **创建 dashboards**：将 panels 组织成逻辑组
- **SQL 查询**：为 PostgreSQL data source 编写 SQL 查询
- **告警**：第 11.3 节涵盖基于 dashboard metrics 的告警

**在 MarketLag 项目中**：创建 Grafana dashboards 以可视化 lag signals（每小时计数、confidence 分布）和系统健康状态（Flink metrics、Kafka metrics）。使用 PostgreSQL data source 获取 lag signals。理解 Grafana dashboard 创建对监控和可视化至关重要。

---

## Summary

Grafana dashboard 创建支持可视化 MarketLag 系统健康状态和 lag signals。配置 data sources（PostgreSQL、Prometheus）。使用 panel 类型（time series、histogram、scatter plot、table）。编写 SQL 查询进行数据可视化。将 dashboard 组织成逻辑组。MarketLag 在 Grafana 中可视化 lag signals 和系统健康状态。理解 Grafana dashboard 创建对监控和可视化至关重要。

