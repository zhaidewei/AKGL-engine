# 关键词评分系统

**Learning Point**: 12.3 from knowledge_and_skills_needed_v2.md
**Prerequisites**: Understanding of text processing, aggregations
**Version**: Flink 2.2.0

---

## 工程化定义

**Keyword Scoring System**: A mechanism to convert RSS article content into numerical signals by assigning weights to keywords and aggregating their occurrences.

**Keyword Weights**: Numerical values assigned to keywords indicating their importance. Positive weights indicate positive sentiment, negative weights indicate negative sentiment.

**Keyword Occurrence Counting**: Counting how many times each keyword appears in an article.

**Keyword Score Aggregation**: Summing weighted keyword occurrences to produce an article score. Formula: `SUM(weight × count)` per article.

---

## 通俗解释

将 keyword scoring 想象成情感分析器：

- **Keyword Weights** = 重要性分数："Fed" = 2.0（非常重要），"dovish" = -1.5（负面）
- **Occurrence Counting** = 出现次数："Fed 在这篇文章中出现 3 次"
- **Score Aggregation** = 总分："Fed (3×2.0) + hike (2×2.0) = 10.0 文章分数"

**为什么需要**：MarketLag 将 RSS 文章文本转换为数值信号。Keyword scoring 量化文章情感和重要性。

---

## 类比理解

如果您了解 **TF-IDF** 或 **sentiment analysis**（您了解），keyword scoring 类似：
- TF-IDF weights = Keyword weights（都分配重要性）
- Word frequency = Keyword occurrence counting（都计算出现次数）
- Document score = Article score（都聚合产生分数）

关键区别：Keyword scoring 使用特定领域的权重（Fed、rate、hike）而不是统计权重。

---

## 与已学内容的关系

- **12.4 Source Weighting**：Article scores 按 source credibility 加权
- **3.1 Window Functions**：Keyword scores 在窗口上聚合
- **Text Processing**：您已经了解文本处理 - keyword scoring 应用了它

---

## 伪代码（基于项目设计）

Based on MarketLag project design:

```python
# Keyword weights (simplified)
KEYWORD_WEIGHTS = {
    'Fed': 2.0,
    'rate': 1.5,
    'hike': 2.0,
    'dovish': -1.5
}

# Keyword scoring (simplified)
def calculate_article_score(article_text, keywords):
    score = 0
    for keyword, weight in KEYWORD_WEIGHTS.items():
        count = article_text.lower().count(keyword.lower())
        score += weight * count
    return score
```

---

## 源码参考

**Project Design**: `generation_pipeline/step1_output_project_design/output_project_design_v5.md`

**Implementation**: This is implemented in MarketLag RSS producer (Lambda function, section 8.1).

---

## 关键词权重：正向与负向

### Positive Keywords (Market-Bullish)

**Weights**:
- **Fed**: 2.0 (high importance)
- **rate**: 1.5 (medium importance)
- **hike**: 2.0 (high importance)

**Meaning**: These keywords indicate positive market movement (rate hikes, Fed actions).

### Negative Keywords (Market-Bearish)

**Weights**:
- **dovish**: -1.5 (negative sentiment)

**Meaning**: This keyword indicates negative market movement (dovish = less aggressive).

### Weight Selection

**Criteria**:
- **Importance**: How much does this keyword affect market?
- **Sentiment**: Positive (rate hike) vs negative (dovish)
- **Domain Knowledge**: Based on financial market understanding

**MarketLag**: Uses these weights for Fed-related market analysis.

---

## 关键词出现次数统计

### Counting Process

1. **Text Normalization**: Convert to lowercase for case-insensitive matching
2. **Pattern Matching**: Count keyword occurrences in article text
3. **Aggregation**: Sum counts per keyword

### Example

**Article Text**: "Fed raises rates. Fed officials signal more hikes."

**Counts**:
- "Fed": 2 occurrences
- "rate": 1 occurrence (in "rates")
- "hike": 1 occurrence (in "hikes")
- "dovish": 0 occurrences

---

## 关键词得分聚合：每篇文章 SUM(weight × count)

### Formula

```
article_score = SUM(keyword_weight × keyword_count) for all keywords
```

### Example Calculation

**Article**: "Fed raises rates. Fed officials signal more hikes."

**Counts and Weights**:
- Fed: count=2, weight=2.0 → score = 2 × 2.0 = 4.0
- rate: count=1, weight=1.5 → score = 1 × 1.5 = 1.5
- hike: count=1, weight=2.0 → score = 1 × 2.0 = 2.0
- dovish: count=0, weight=-1.5 → score = 0 × (-1.5) = 0.0

**Article Score**: 4.0 + 1.5 + 2.0 + 0.0 = **7.5**

### MarketLag Implementation

```python
# In RSS producer (Lambda)
def calculate_keyword_score(article_text, keywords):
    score = 0.0
    text_lower = article_text.lower()

    for keyword, weight in KEYWORD_WEIGHTS.items():
        count = text_lower.count(keyword.lower())
        score += weight * count

    return score
```

---

## 最小可用代码

```python
# Keyword scoring implementation
KEYWORD_WEIGHTS = {
    'Fed': 2.0,
    'rate': 1.5,
    'hike': 2.0,
    'dovish': -1.5
}

def calculate_article_score(article_text):
    """
    Calculate article score based on keyword weights and occurrences.

    Args:
        article_text: Article text content

    Returns:
        float: Article score
    """
    score = 0.0
    text_lower = article_text.lower()

    for keyword, weight in KEYWORD_WEIGHTS.items():
        # Count occurrences (case-insensitive)
        count = text_lower.count(keyword.lower())
        # Add weighted score
        score += weight * count

    return score

# Example
article = "Fed raises rates. Fed officials signal more hikes."
score = calculate_article_score(article)
print(f"Article score: {score}")  # Output: 7.5
```

---

## 常见错误

1. **大小写敏感性**：
   - ❌ 区分大小写匹配（"Fed" vs "fed"）
   - ✅ 使用不区分大小写匹配：`text.lower().count(keyword.lower())`

2. **部分单词匹配**：
   - ❌ 在 "operate" 中匹配 "rate"（部分匹配）
   - ✅ 使用单词边界或全词匹配

3. **缺少关键词**：
   - ❌ 不计算所有相关关键词
   - ✅ 定义全面的关键词列表

4. **错误的权重**：
   - ❌ 对所有关键词使用相等权重
   - ✅ 使用领域知识分配适当的权重

5. **不归一化**：
   - ❌ 原始计数不归一化
   - ✅ 如果需要，考虑文章长度归一化

---

## 触发点：什么时候想到这个概念

在以下情况下考虑 keyword scoring：
- **处理 RSS 文章**：MarketLag 将文章文本转换为 signals
- **设计权重**：选择适当的关键词权重
- **聚合分数**：第 12.4 节涵盖 source-weighted 聚合
- **调整系统**：根据结果调整权重
- **扩展关键词**：随着项目发展添加新关键词

**在 MarketLag 项目中**：Keyword scoring 将 RSS 文章内容转换为数值信号。Article scores 然后按 source credibility 加权（第 12.4 节）并在窗口上聚合（Job 1）。理解 keyword scoring 对 signal 生成至关重要。

---

## 小结

Keyword scoring 系统通过为关键词分配权重并聚合出现次数，将 RSS 文章内容转换为数值信号。正面关键词（Fed=2.0、rate=1.5、hike=2.0）表示正面情感，负面关键词（dovish=-1.5）表示负面情感。Article score = 所有关键词的 SUM(weight × count)。MarketLag 在 RSS producer（Lambda）中实现此功能。理解 keyword scoring 对项目中的 signal 生成至关重要。

